<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EIXA - Central de Inteligência</title>
    
    <!-- Fonts: Space Grotesk (Premium Display), Nunito (Amável/Acolhedora) & Inter (Leitura técnica) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Nunito:wght@400;600;700;800&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <style>
        :root {
            /* --- VARIAVEIS GERAIS (Light Mode Default) --- */
            --font-display: 'Space Grotesk', 'Nunito', sans-serif;
            --font-body: 'Inter', sans-serif;

            --bg-app: #F2F4F7;
            --bg-sidebar: #FFFFFF;
            --bg-card: #FFFFFF;
            --bg-input: #F9FAFB;
            
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --text-tertiary: #9CA3AF;

            --accent-primary: #7C3AED; /* Violeta Moderno */
            --accent-glow: rgba(124, 58, 237, 0.3);
            --accent-light: #DDD6FE;
            
            --border-subtle: #E5E7EB;
            --shadow-card: 0 4px 20px -2px rgba(0, 0, 0, 0.08), 0 2px 8px -2px rgba(0, 0, 0, 0.04); /* Premium Shadow */
            
            --status-success: #10B981;
            --status-warning: #F59E0B;
            --status-error: #EF4444;

            --nav-height-mobile: 80px;
            --pull-refresh-height: 80px;
            --bottom-sheet-drag-handle: 4px;
        }

        /* --- TRUE BLACK MODE (OLED/AMOLED) --- */
        body.dark-mode {
            --bg-app: #000000; /* True Black */
            --bg-sidebar: #0A0A0A;
            --bg-card: #121212; /* Material Dark Surface */
            --bg-input: #1E1E1E;

            --text-primary: #F9FAFB;
            --text-secondary: #A3A3A3;
            --text-tertiary: #525252;

            --accent-primary: #A78BFA; /* Violeta Pastel para contraste no preto */
            --accent-glow: rgba(167, 139, 250, 0.15);
            --accent-light: #2E1065;

            --border-subtle: #262626;
            --shadow-card: none; /* Em true black, usamos bordas sutis ou cores de fundo */
        }

        /* --- AURORA BACKGROUND --- */
        .aurora-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            background-color: var(--bg-app);
            transition: background-color 0.3s ease;
        }
        .aurora-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            animation: auroraMove 20s infinite alternate;
        }
        .orb-1 {
            top: -10%;
            left: -10%;
            width: 50vw;
            height: 50vw;
            background: var(--accent-primary);
            animation-duration: 25s;
        }
        .orb-2 {
            bottom: -10%;
            right: -10%;
            width: 60vw;
            height: 60vw;
            background: #4f46e5; /* Indigo */
            animation-duration: 30s;
            animation-delay: -5s;
        }
        .orb-3 {
            top: 40%;
            left: 40%;
            width: 30vw;
            height: 30vw;
            background: #ec4899; /* Pink */
            opacity: 0.2;
            animation-duration: 20s;
            animation-delay: -10s;
        }

        @keyframes auroraMove {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(50px, 50px) scale(1.1); }
        }

        /* --- PULL TO REFRESH --- */
        .pull-refresh-container {
            position: absolute;
            top: -80px;
            left: 0;
            right: 0;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            backdrop-filter: blur(16px);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 50;
        }
        .pull-refresh-container.active {
            transform: translateY(80px);
        }
        .pull-refresh-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-subtle);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- BOTTOM SHEETS (Mobile Modal Alternative) --- */
        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-radius: 24px 24px 0 0;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10003;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
        }
        .bottom-sheet.active {
            transform: translateY(0);
        }
        .bottom-sheet-handle {
            width: 40px;
            height: 4px;
            background: var(--border-subtle);
            border-radius: 2px;
            margin: 12px auto 20px;
            cursor: grab;
        }
        .bottom-sheet-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 10002;
        }
        .bottom-sheet-backdrop.active {
            opacity: 1;
            pointer-events: all;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-app);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* --- LAYOUT PRINCIPAL --- */
        .app-container {
            display: flex;
            height: 100%;
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* --- SIDEBAR (Desktop) / BOTTOM NAV (Mobile) --- */
        .sidebar {
            width: 280px;
            background-color: rgba(10, 10, 10, 0.6); /* Glass effect base */
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-right: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            flex-direction: column;
            padding: 24px;
            flex-shrink: 0;
            z-index: 100;
            transition: all 0.3s ease;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 40px;
            padding-left: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: transparent;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-family: var(--font-display);
            font-size: 20px;
            /* box-shadow: 0 0 15px var(--accent-glow); Removed glow for img */
        }
        .logo-icon img { width: 100%; height: 100%; object-fit: contain; }

        .logo-text {
            font-family: var(--font-display);
            font-weight: 800;
            font-size: 24px;
            letter-spacing: -0.5px;
            color: var(--text-primary);
        }

        .nav-links {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-grow: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 16px;
            border-radius: 16px;
            color: var(--text-secondary);
            font-weight: 500;
            font-family: var(--font-display);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
        }

        .nav-item:hover {
            background-color: var(--bg-app);
            color: var(--text-primary);
            transform: translateX(4px);
            border-color: rgba(255, 255, 255, 0.05);
        }

        .nav-item:active {
            transform: translateX(4px) scale(0.98);
        }

        .nav-item.active {
            background-color: var(--accent-light);
            color: var(--accent-primary);
            font-weight: 700;
            border-color: rgba(99, 102, 241, 0.3);
            box-shadow: 0 4px 12px -2px rgba(99, 102, 241, 0.25);
        }
        
        /* Dark mode adjustment for active state text color if needed */
        body.dark-mode .nav-item.active {
            color: #E0E7FF; /* Lighter text on dark violet bg */
        }

        .nav-icon { font-size: 24px; }

        .user-mini-profile {
            margin-top: auto;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-top: 1px solid var(--border-subtle);
            padding-top: 20px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--bg-input);
            border: 2px solid var(--accent-primary);
            overflow: hidden;
        }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        .user-info h4 { font-size: 14px; font-weight: 600; font-family: var(--font-display); }
        .user-info p { font-size: 12px; color: var(--text-secondary); }

        .theme-toggle {
            margin-left: auto;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
        }

        /* --- ÁREA PRINCIPAL --- */
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            position: relative;
            background-color: var(--bg-app);
        }

        /* Views Container */
        .view-section {
            display: none;
            padding: 20px 40px;
            max-width: 1200px;
            margin: 0 auto;
            animation: fadeIn 0.3s ease;
            padding-bottom: 100px; /* Space for mobile nav */
        }

        .view-section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes slideOutLeft {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(-30px); }
        }

        .view-section.slide-in {
            animation: slideInRight 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .view-section.slide-out {
            animation: slideOutLeft 0.3s cubic-bezier(0.55, 0.085, 0.68, 0.53);
        }

        .page-header {
            margin-top: 40px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
            background-color: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 16px 24px;
            margin-left: -40px;
            margin-right: -40px;
            padding-left: 40px;
            padding-right: 40px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .page-title {
            font-family: var(--font-display);
            font-size: 32px;
            font-weight: 800;
            color: var(--text-primary);
        }

        .btn-primary {
            background-color: var(--accent-primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-family: var(--font-display);
            display: flex;
            align-items: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
            cursor: pointer;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px -4px rgba(99, 102, 241, 0.5);
            background-color: #7c3aed;
        }

        .btn-primary:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 4px 12px -2px rgba(99, 102, 241, 0.4);
            gap: 8px;
            cursor: pointer;
            box-shadow: 0 4px 12px var(--accent-glow);
            transition: transform 0.2s;
        }
        .btn-primary:active { transform: scale(0.98); }

        .btn-secondary {
            background-color: var(--bg-card);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
            padding: 10px 16px;
            border-radius: 10px;
            font-weight: 600;
            font-family: var(--font-display);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        /* --- CARDS & UI COMPONENTS --- */
        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-card);
            transition: transform 0.2s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px -8px rgba(99, 102, 241, 0.15);
        }

        .modal .card {
            background-color: rgba(18, 18, 18, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title { font-size: 18px; font-weight: 700; font-family: var(--font-display); color: var(--text-primary); }
        
        .tag {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .tag-purple { background-color: var(--accent-light); color: var(--accent-primary); }
        .tag-gray { background-color: var(--bg-input); color: var(--text-secondary); border: 1px solid var(--border-subtle); }

        /* --- VIEW: CHAT --- */
        #chat-view {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0;
            max-width: none;
            overflow: hidden;
        }

        .chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
            height: 100%;
        }

        .chat-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .message {
            max-width: 80%;
            padding: 16px 20px;
            border-radius: 18px;
            line-height: 1.6;
            font-size: 15px;
            position: relative;
        }

        .message-ai {
            background-color: var(--bg-card);
            color: var(--text-primary);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            border: 1px solid var(--border-subtle);
        }

        .message-user {
            background-color: var(--accent-primary);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        .chat-input-area {
            padding: 20px;
            background-color: var(--bg-card);
            border-top: 1px solid var(--border-subtle);
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            background-color: var(--bg-input);
            padding: 8px;
            border-radius: 16px;
            border: 1px solid var(--border-subtle);
            align-items: center;
        }

        .chat-input {
            flex-grow: 1;
            border: none;
            background: transparent;
            padding: 12px;
            font-family: var(--font-body);
            font-size: 16px;
            color: var(--text-primary);
            outline: none;
        }

        /* --- VIEW: AGENDA (Week & Month) --- */
        .agenda-controls {
            display: flex;
            gap: 12px;
            background: var(--bg-card);
            padding: 4px;
            border-radius: 12px;
            border: 1px solid var(--border-subtle);
        }

        .view-toggle {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            color: var(--text-secondary);
            border: none;
            background: none;
        }

        .view-toggle.active {
            background-color: var(--accent-primary);
            color: white;
        }

        /* Agenda Grid System */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: var(--border-subtle);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            overflow: hidden;
        }

        .cal-header {
            background-color: var(--bg-card);
            padding: 16px;
            text-align: center;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .cal-day {
            background-color: var(--bg-card);
            min-height: 120px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: background-color 0.2s;
        }
        
        .cal-day:hover { background-color: var(--bg-input); }

        .day-number {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 4px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .day-number.today {
            background-color: var(--accent-primary);
            color: white;
        }

        .event-chip {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 6px;
            background-color: var(--accent-light);
            color: var(--accent-primary);
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-left: 3px solid var(--accent-primary);
        }

        /* Weekly View Columns */
        .weekly-view-container {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding-bottom: 20px;
        }

        .day-column {
            flex: 1;
            min-width: 140px;
            background-color: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-subtle);
            padding: 16px;
        }

        .day-col-header {
            text-align: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-subtle);
        }

        /* --- VIEW: PERFIL (Long Term Memory) --- */
        .profile-header-card {
            background: linear-gradient(135deg, var(--accent-primary), #9333ea);
            color: white;
            padding: 32px;
            border-radius: 24px;
            display: flex;
            align-items: center;
            gap: 24px;
            margin-bottom: 32px;
        }

        .profile-big-avatar {
            width: 80px;
            height: 80px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 700;
            border: 3px solid white;
        }

        .profile-data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }

        .profile-section-title {
            font-family: var(--font-display);
            font-size: 16px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            margin-top: 8px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-subtle);
        }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: var(--text-secondary); font-size: 14px; }
        .info-value { font-weight: 600; color: var(--text-primary); font-size: 14px; text-align: right;}

        .trait-cloud {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        /* --- VIEW: PROJETOS --- */
        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
        }

        .progress-bar {
            height: 6px;
            background-color: var(--bg-input);
            border-radius: 3px;
            margin-top: 12px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: var(--status-success);
            border-radius: 3px;
            transition: width 0.5s ease, box-shadow 0.3s ease;
        }

        .progress-fill.complete {
            background: linear-gradient(90deg, var(--status-success), #10b981, var(--status-success));
            background-size: 200% 100%;
            animation: progressShine 2s ease-in-out infinite;
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.6);
        }

        @keyframes progressShine {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* --- ROUTINES --- */
        .routine-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .routine-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .routine-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
            padding-top: 12px;
            border-top: 1px solid var(--border-subtle);
        }
        .routine-item-row {
            display: flex;
            gap: 12px;
            font-size: 13px;
            color: var(--text-secondary);
            align-items: center;
        }

        /* --- PROJECT DETAIL --- */
        .project-detail-header {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-input));
            padding: 32px;
            border-radius: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border-subtle);
        }

        /* --- SUGGESTIONS UI --- */
        .suggestions-container {
            margin-top: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            max-width: 600px;
        }
        .suggestion-card {
            background-color: var(--bg-card);
            border: 1px solid var(--accent-light);
            border-left: 4px solid var(--accent-primary);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            animation: fadeIn 0.3s ease;
        }
        .suggestion-info h4 {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .suggestion-info p {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .suggestion-actions {
            display: flex;
            gap: 8px;
        }
        .btn-accept {
            background-color: var(--accent-primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-reject {
            background-color: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-subtle);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-reject:hover {
            background-color: var(--bg-input);
            color: var(--status-error);
        }

        /* --- RICH UI COMPONENTS --- */
        .rich-component {
            background-color: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
            animation: fadeIn 0.3s ease;
        }
        .rich-component h4 {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 12px 0;
        }
        .calendar-invite {
            border-left: 4px solid var(--accent-primary);
        }
        .chart-widget {
            border-left: 4px solid #10b981;
        }
        .quick-action {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border-color: var(--accent-light);
        }

        /* --- TYPING INDICATOR --- */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 8px 0;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: var(--text-secondary);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* --- DASHBOARD BENTO GRID --- */
        .bento-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 20px;
            margin-top: 20px;
        }
        .bento-item {
            background-color: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 24px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .bento-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px -5px rgba(0,0,0,0.1);
        }
        .bento-large { grid-column: span 2; }
        .bento-tall { grid-row: span 2; }
        
        .greeting-widget h2 {
            font-family: var(--font-display);
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(to right, var(--text-primary), var(--accent-primary));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        .weather-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.1);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            backdrop-filter: blur(4px);
        }

        .focus-widget {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-light));
            color: white;
            border: none;
        }
        .focus-widget h3 { color: rgba(255,255,255,0.9); font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
        .focus-task-title { font-size: 24px; font-weight: 700; margin: 12px 0; line-height: 1.2; }
        
        .stats-widget { text-align: center; }
        .stats-circle {
            width: 80px; height: 80px;
            border-radius: 50%;
            background: conic-gradient(var(--accent-primary) 0% 0%, var(--bg-input) 0% 100%);
            margin: 0 auto 12px;
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        .stats-circle::before {
            content: ''; position: absolute;
            width: 64px; height: 64px;
            background-color: var(--bg-card);
            border-radius: 50%;
        }
        .stats-value { position: relative; font-size: 20px; font-weight: 800; }

        @media (max-width: 1024px) {
            .bento-grid { grid-template-columns: 1fr 1fr; }
            .bento-large { grid-column: span 2; }
        }
        @media (max-width: 768px) {
            .bento-grid { grid-template-columns: 1fr; }
            .bento-large, .bento-tall { grid-column: span 1; grid-row: span 1; }
        }

        /* --- MOBILE RESPONSIVE --- */
        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            
            .sidebar {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                height: var(--nav-height-mobile);
                flex-direction: row;
                justify-content: space-around;
                padding: 10px;
                border-right: none;
                border-top: 1px solid var(--border-subtle);
                border-top-left-radius: 20px;
                border-top-right-radius: 20px;
                box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            }

            .logo-area, .user-mini-profile { display: none; }
            
            .nav-links {
                flex-direction: row;
                width: 100%;
                justify-content: space-around;
            }

            .nav-item {
                flex-direction: column;
                gap: 4px;
                padding: 8px;
                font-size: 10px;
                border-radius: 12px;
            }

            .nav-icon { font-size: 24px; }
            .nav-text { display: block; }

            .main-content {
                padding-bottom: var(--nav-height-mobile);
            }

            .view-section {
                padding: 16px;
                padding-bottom: 100px;
            }

            .page-header {
                margin-top: 20px;
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
            
            .calendar-grid {
                font-size: 12px;
            }
            .cal-header { padding: 8px 4px; }
            .cal-day { min-height: 80px; padding: 4px; }
            .event-chip { font-size: 9px; padding: 2px 4px; }
            
            .profile-header-card {
                flex-direction: column;
                text-align: center;
                padding: 24px;
            }
        }
        
        /* --- DASHBOARD BENTO GRID --- */
        .bento-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 20px;
            margin-top: 20px;
        }
        .bento-item {
            background-color: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 24px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .bento-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px -5px rgba(0,0,0,0.1);
        }
        .bento-large { grid-column: span 2; }
        .bento-tall { grid-row: span 2; }
        
        .greeting-widget h2 {
            font-family: var(--font-display);
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(to right, var(--text-primary), var(--accent-primary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        .weather-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.1);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            backdrop-filter: blur(4px);
        }

        .focus-widget {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-light));
            color: white;
            border: none;
        }
        .focus-widget h3 { color: rgba(255,255,255,0.9); font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
        .focus-task-title { font-size: 24px; font-weight: 700; margin: 12px 0; line-height: 1.2; }
        
        .stats-widget { text-align: center; }
        .stats-circle {
            width: 80px; height: 80px;
            border-radius: 50%;
            background: conic-gradient(var(--accent-primary) 0% 0%, var(--bg-input) 0% 100%);
            margin: 0 auto 12px;
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        .stats-circle::before {
            content: ''; position: absolute;
            width: 64px; height: 64px;
            background-color: var(--bg-card);
            border-radius: 50%;
        }
        .stats-value { position: relative; font-size: 20px; font-weight: 800; }

        @media (max-width: 1024px) {
            .bento-grid { grid-template-columns: 1fr 1fr; }
            .bento-large { grid-column: span 2; }
        }
        @media (max-width: 768px) {
            .bento-grid { grid-template-columns: 1fr; }
            .bento-large, .bento-tall { grid-column: span 1; grid-row: span 1; }
        }

        /* --- KANBAN STYLES --- */
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            height: calc(100vh - 200px);
            overflow-x: auto;
            padding-bottom: 20px;
        }
        .kanban-column {
            background-color: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            min-width: 280px;
        }
        .kanban-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
        }
        .kanban-header h3 { font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .kanban-header .count { background: var(--bg-input); padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        
        .kanban-items {
            padding: 16px;
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .kanban-card {
            background-color: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 16px;
            cursor: grab;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .kanban-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: var(--accent-primary);
        }
        .kanban-card:active { cursor: grabbing; }

        @media (max-width: 768px) {
            .kanban-board {
                grid-template-columns: 1fr; /* Stack on mobile or use horizontal scroll */
                grid-auto-flow: column;
                grid-auto-columns: 85%;
                gap: 16px;
            }
        }

        /* Auth Section Styles (Adapted from previous) */
        .auth-section {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%; min-height: 100vh;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 24px; background-color: #0A0A0A; z-index: 9999;
            opacity: 0; visibility: hidden; transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        .auth-section.active { opacity: 1; visibility: visible; }
        .auth-card {
            background-color: var(--bg-card); padding: 48px 32px; border-radius: 24px;
            box-shadow: var(--shadow-card); border: 1px solid var(--border-subtle);
            max-width: 450px; width: 100%; text-align: center;
        }
        .auth-card-title { font-family: var(--font-display); font-size: 1.8em; color: var(--text-primary); margin-bottom: 8px; }
        .auth-card-subtitle { font-family: var(--font-body); font-size: 1em; color: var(--text-secondary); margin-bottom: 24px; }
        .input-group { margin-bottom: 16px; width: 100%; }
        .input-group input { width: 100%; padding: 16px; border: 1px solid var(--border-subtle); background-color: var(--bg-input); border-radius: 12px; color: var(--text-primary); }
        .auth-buttons-group { display: flex; flex-direction: column; gap: 16px; margin-top: 16px; }
        .auth-button { width: 100%; padding: 16px; font-weight: 600; border-radius: 12px; cursor: pointer; border: none; }
        .button-primary.auth-button { background-color: var(--accent-primary); color: white; }
        .button-secondary.auth-button { background-color: var(--bg-input); color: var(--text-primary); border: 1px solid var(--border-subtle); }
        .google-button { background-color: white; color: #111; border: 1px solid var(--border-subtle); display: flex; align-items: center; justify-content: center; gap: 8px; }
        .google-icon { width: 20px; height: 20px; }
        .divider { margin: 16px 0; color: var(--text-secondary); font-size: 0.9em; }
        .error-message { color: var(--status-error); margin-bottom: 16px; display: none; }
        
        /* Global Loader */
        .global-loader {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--bg-app); z-index: 10000;
            display: flex; justify-content: center; align-items: center;
            opacity: 1; visibility: visible; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .global-loader.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        #loader-eixa { width: 64px; height: 64px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(0.95); opacity: 0.8; } 50% { transform: scale(1.05); opacity: 1; } 100% { transform: scale(0.95); opacity: 0.8; } }

        /* --- BADGES --- */
        .badge {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 2px 8px; border-radius: 12px;
            font-size: 10px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .badge-eixa {
            background: linear-gradient(135deg, #D0B0FF 0%, #A78BFA 100%);
            color: #2E1065;
            box-shadow: 0 2px 4px rgba(167, 139, 250, 0.2);
        }
        .badge-google {
            background: linear-gradient(135deg, #4285F4 0%, #1967D2 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(66, 133, 244, 0.2);
        }
        .badge-routine {
            background: linear-gradient(135deg, #34A853 0%, #188038 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(52, 168, 83, 0.2);
        }
        
        .completion-icon {
            color: var(--status-success);
            filter: drop-shadow(0 0 2px var(--status-success));
        }

        /* --- SPEED DIAL (FAB) --- */
        .speed-dial {
            position: fixed;
            bottom: 80px;
            right: 24px;
            z-index: 1000;
        }

        .fab-main {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--accent-primary), #9333ea);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 8px 24px -4px rgba(99, 102, 241, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55), box-shadow 0.3s ease;
        }

        .fab-main:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 12px 32px -4px rgba(99, 102, 241, 0.7);
        }

        .fab-main.active {
            transform: rotate(45deg);
        }

        .fab-options {
            position: absolute;
            bottom: 70px;
            right: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .fab-options.active {
            opacity: 1;
            pointer-events: all;
        }

        .fab-option {
            display: flex;
            align-items: center;
            gap: 12px;
            background-color: var(--bg-card);
            border: 1px solid var(--border-subtle);
            padding: 12px 16px;
            border-radius: 28px;
            cursor: pointer;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: scale(0.8) translateY(10px);
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55), opacity 0.3s ease;
            opacity: 0;
        }

        .fab-options.active .fab-option {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        .fab-options.active .fab-option:nth-child(1) { transition-delay: 0.05s; }
        .fab-options.active .fab-option:nth-child(2) { transition-delay: 0.1s; }
        .fab-options.active .fab-option:nth-child(3) { transition-delay: 0.15s; }

        .fab-option:hover {
            background-color: var(--accent-light);
            border-color: var(--accent-primary);
            transform: translateX(-4px) scale(1.05);
        }

        .fab-option .material-icons-round {
            font-size: 20px;
            color: var(--accent-primary);
        }

        .fab-option span {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .speed-dial {
                bottom: 100px;
                right: 16px;
            }
        }
    </style>
</head>
<body class="dark-mode"> <!-- Defaulting to True Black as requested -->
    <div class="aurora-bg">
        <div class="aurora-orb orb-1"></div>
        <div class="aurora-orb orb-2"></div>
        <div class="aurora-orb orb-3"></div>
    </div>

    <div id="globalLoader" class="global-loader">
        <img id="loader-eixa" src="./assets/img/eixa.svg" alt="Carregando EIXA" />
    </div>

    <!-- Auth Section -->
    <section id="authSection" class="auth-section">
        <div class="auth-card">
            <div class="logo-icon" style="margin: 0 auto 24px auto; width: 80px; height: 80px;"><img src="./assets/img/eixa.svg" alt="EIXA"></div>
            <h1 class="auth-card-title">Bem-vindo à EIXA</h1>
            <p class="auth-card-subtitle">Sua central de inteligência pessoal.</p>
            
            <div id="manualAuthContainer">
                <div class="input-group">
                    <input type="email" id="emailInput" placeholder="Seu email" required autocomplete="email">
                </div>
                <div class="input-group">
                    <input type="password" id="passwordInput" placeholder="Sua senha" required minlength="6" autocomplete="current-password">
                </div>
                <div id="authErrorMessage" class="error-message"></div>
                <div class="auth-buttons-group">
                    <button id="emailLoginBtn" class="button-primary auth-button">Entrar</button>
                    <button id="emailSignupBtn" class="button-secondary auth-button">Cadastrar</button>
                    <div class="divider">OU</div>
                    <button id="googleLoginBtn" class="auth-button google-button">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" class="google-icon">
                        Entrar com Google
                    </button>
                </div>
            </div>
        </div>
    </section>

    <div class="app-container" id="mainAppContainer" style="display: none;">
        
        <!-- SIDEBAR NAVIGATION -->
        <aside class="sidebar" id="sidebarMenu">
            <div class="logo-area">
                <div class="logo-icon"><img src="./assets/img/eixa.svg" alt="EIXA"></div>
                <div class="logo-text">EIXA</div>
            </div>

            <nav class="nav-links">
                <div class="nav-item" onclick="switchView('dashboard')" data-target="dashboard">
                    <span class="material-icons-round nav-icon">dashboard</span>
                    <span class="nav-text">Início</span>
                </div>
                <div class="nav-item active" onclick="switchView('chat')" data-target="chat">
                    <span class="material-icons-round nav-icon">chat_bubble</span>
                    <span class="nav-text">Chat</span>
                </div>
                <div class="nav-item" onclick="switchView('agenda')" data-target="agenda">
                    <span class="material-icons-round nav-icon">calendar_month</span>
                    <span class="nav-text">Agenda</span>
                </div>
                <div class="nav-item" onclick="switchView('projects')" data-target="projects">
                    <span class="material-icons-round nav-icon">folder_copy</span>
                    <span class="nav-text">Projetos</span>
                </div>
                <div class="nav-item" onclick="switchView('kanban')" data-target="kanban">
                    <span class="material-icons-round nav-icon">view_kanban</span>
                    <span class="nav-text">Kanban</span>
                </div>
                <div class="nav-item" onclick="switchView('memories')" data-target="memories">
                    <span class="material-icons-round nav-icon">psychology</span>
                    <span class="nav-text">Memórias</span>
                </div>
                <div class="nav-item" onclick="switchView('diagnostico')" data-target="diagnostico">
                    <span class="material-icons-round nav-icon">analytics</span>
                    <span class="nav-text">Diagnóstico</span>
                </div>
                <div class="nav-item" onclick="switchView('profile')" data-target="profile">
                    <span class="material-icons-round nav-icon">person</span>
                    <span class="nav-text">Perfil</span>
                </div>
            </nav>

            <div class="user-mini-profile">
                <div class="avatar">
                    <img src="https://api.dicebear.com/7.x/notionists/svg?seed=Felix&backgroundColor=b6e3f4" alt="User" id="userAvatarImg">
                </div>
                <div class="user-info">
                    <h4 id="userNameDisplay">Usuário</h4>
                    <p>Free Plan</p>
                </div>
                <button class="theme-toggle" onclick="toggleTheme()" id="themeToggleBtn">
                    <span class="material-icons-round">light_mode</span>
                </button>
                <button class="theme-toggle" id="signOutBtn" title="Sair">
                    <span class="material-icons-round">logout</span>
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <main class="main-content" id="mainContentArea">
            <!-- PULL TO REFRESH INDICATOR -->
            <div class="pull-refresh-container">
                <div class="pull-refresh-spinner"></div>
            </div>

            <!-- VIEW: DASHBOARD (Bento Grid) -->
            <section id="view-dashboard" class="view-section">
                <div id="dashboard-content">
                    <!-- Content generated via JS -->
                </div>
            </section>

            <!-- VIEW: CHAT -->
            <section id="view-chat" class="view-section active" style="padding:0; max-width: none;">
                <div id="chat-view">
                    <!-- Chat Header (Mobile Only mostly) -->
                    <div style="padding: 16px 24px; border-bottom: 1px solid var(--border-subtle); display:flex; align-items:center; justify-content:space-between;">
                        <div>
                            <h2 style="font-family:var(--font-display); font-size:18px;">Central de Comando</h2>
                            <p style="font-size:12px; color:var(--status-success); display:flex; align-items:center; gap:4px;">
                                <span style="width:8px; height:8px; background:var(--status-success); border-radius:50%;"></span> Online
                            </p>
                        </div>
                    </div>

                    <div class="chat-messages" id="chat-display">
                        <div class="message message-ai">
                            <strong>EIXA</strong><br>
                            Olá! Como posso ajudar a organizar seu fluxo hoje?
                        </div>
                    </div>

                    <div class="chat-input-area">
                        <div class="input-wrapper">
                            <button style="background:none; border:none; color:var(--text-secondary); padding:8px; cursor:pointer;" id="fileUploadBtn">
                                <span class="material-icons-round">add_circle</span>
                            </button>
                            <input type="file" id="fileInput" style="display: none;">
                            <input type="text" class="chat-input" id="message-input" placeholder="Converse com a EIXA...">
                            <button style="background:var(--accent-primary); border:none; color:white; padding:8px; border-radius:10px; cursor:pointer; display:flex;" id="send-btn">
                                <span class="material-icons-round">send</span>
                            </button>
                        </div>
                        <div class="attachment-info" style="display: none; margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
                            <span class="file-name-display"></span>
                            <span class="material-icons-round attachment-clear-icon" style="font-size: 14px; cursor: pointer; margin-left: 4px;">close</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW: AGENDA -->
            <section id="view-agenda" class="view-section">
                <div class="page-header">
                    <h1 class="page-title">Minha Agenda</h1>
                    <div style="display:flex; gap:12px;">
                        <button class="btn-primary" onclick="openModal('taskModal')">
                            <span class="material-icons-round">add</span> Tarefa
                        </button>
                        <div class="agenda-controls">
                            <button class="view-toggle active" onclick="toggleCalendarView('week')">Semanal</button>
                            <button class="view-toggle" onclick="toggleCalendarView('month')">Mensal</button>
                            <button class="view-toggle" onclick="toggleCalendarView('routines')">Rotinas</button>
                        </div>
                    </div>
                </div>

                <!-- Weekly View -->
                <div id="agenda-week" class="weekly-view-container">
                    <!-- Columns generated via JS -->
                </div>

                <!-- Monthly View (Hidden by default) -->
                <div id="agenda-month" style="display:none;">
                    <div class="calendar-grid" id="calendar-grid-month">
                        <div class="cal-header">DOM</div><div class="cal-header">SEG</div><div class="cal-header">TER</div>
                        <div class="cal-header">QUA</div><div class="cal-header">QUI</div><div class="cal-header">SEX</div><div class="cal-header">SAB</div>
                        <!-- Days generated via JS -->
                    </div>
                </div>

                <!-- Routines View (Hidden by default) -->
                <div id="agenda-routines" style="display:none;">
                    <div style="display:flex; justify-content:flex-end; margin-bottom:16px;">
                        <button class="btn-secondary" onclick="openModal('routineModal')">
                            <span class="material-icons-round">add</span> Nova Rotina
                        </button>
                    </div>
                    <div id="routines-list">
                        <!-- Routines generated via JS -->
                    </div>
                </div>
            </section>

            <!-- VIEW: PROJETOS -->
            <section id="view-projects" class="view-section">
                <div class="page-header">
                    <h1 class="page-title">Projetos</h1>
                    <button class="btn-primary" onclick="openModal('projectModal')">
                        <span class="material-icons-round">add</span> Novo Projeto
                    </button>
                </div>

                <div class="project-grid" id="projects-container">
                    <!-- Cards generated via JS -->
                </div>
            </section>

            <!-- VIEW: KANBAN (NOVO) -->
            <section id="view-kanban" class="view-section">
                <div class="page-header">
                    <h1 class="page-title">Quadro Kanban</h1>
                    <p style="color:var(--text-secondary);">Gerencie o fluxo de trabalho arrastando os cartões.</p>
                </div>
                <div id="kanban-board" class="kanban-board">
                    <!-- Kanban columns generated via JS -->
                </div>
            </section>

            <!-- VIEW: PROJECT DETAILS (Hidden by default) -->
            <section id="view-project-details" class="view-section">
                <button class="btn-secondary" onclick="switchView('projects')" style="margin-bottom:20px;">
                    <span class="material-icons-round">arrow_back</span> Voltar
                </button>
                <div id="project-detail-content">
                    <!-- Content generated via JS -->
                </div>
            </section>

            <!-- VIEW: MEMÓRIAS -->
            <section id="view-memories" class="view-section">
                <div class="page-header">
                    <h1 class="page-title">Memórias Emocionais</h1>
                </div>
                
                <div style="column-count: 2; column-gap: 20px;" id="memories-container">
                    <!-- Cards generated via JS -->
                </div>
            </section>

            <!-- VIEW: DIAGNÓSTICO -->
            <section id="view-diagnostico" class="view-section">
                <div class="page-header">
                    <h1 class="page-title">Auto-Diagnóstico</h1>
                </div>
                <div id="diagnostico-content">
                    <!-- Generated via JS -->
                </div>
            </section>

            <!-- VIEW: PERFIL (Long Term Memory) -->
            <section id="view-profile" class="view-section">
                
                <div class="profile-header-card">
                    <div class="profile-big-avatar">M</div>
                    <div>
                        <div style="display:flex; align-items:center; gap:12px;">
                            <h2 style="font-family:var(--font-display); font-size:24px; margin-bottom:4px;" id="profile-name-display">Usuário</h2>
                            <button class="edit-profile-btn" onclick="openEditProfileModal()" style="background:none; border:none; color:white; cursor:pointer;">
                                <span class="material-icons-round">edit</span>
                            </button>
                        </div>
                        <p style="opacity:0.9;">Memória de Longo Prazo & Perfil Psicológico</p>
                        <button id="btn-connect-gcal" class="btn-secondary" style="margin-top:12px; font-size:12px; display:flex; align-items:center; gap:6px;" onclick="connectGoogleCalendar()">
                            <span class="material-icons-round" style="font-size:16px;">event</span> Conectar Google Calendar
                        </button>
                    </div>
                </div>

                <div class="profile-data-grid" id="profile-content">
                    <!-- Content generated via JS -->
                </div>
            </section>

        </main>
    </div>
    
    <div id="toastContainer" style="position: fixed; top: 20px; right: 20px; z-index: 10001; display: flex; flex-direction: column; gap: 10px;"></div>

    <!-- Bottom Sheet Backdrop (Mobile) -->
    <div class="bottom-sheet-backdrop" onclick="closeBottomSheet('taskModal'); closeBottomSheet('projectModal'); closeBottomSheet('confirmationModal');"></div>

    <!-- Modals (Hidden by default) -->
    <div id="confirmationModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10002; align-items:center; justify-content:center;">
        <div class="card" style="width:90%; max-width:400px;">
            <h3 class="card-title" style="margin-bottom:16px;">Confirmação</h3>
            <p id="confirmationMessage" style="margin-bottom:24px; color:var(--text-secondary);"></p>
            <div style="display:flex; justify-content:flex-end; gap:12px;">
                <button class="btn-secondary" id="confirmNoBtn">Cancelar</button>
                <button class="btn-primary" id="confirmYesBtn">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10002; align-items:center; justify-content:center;">
        <div class="card" style="width:90%; max-width:500px;">
            <div class="card-header">
                <h3 class="card-title">Nova Tarefa</h3>
                <button onclick="closeModal('taskModal')" style="background:none; border:none; color:var(--text-secondary); cursor:pointer;"><span class="material-icons-round">close</span></button>
            </div>
            <div class="input-group">
                <label style="display:block; margin-bottom:8px; font-size:14px; color:var(--text-secondary);">Descrição</label>
                <input type="text" id="taskDesc" placeholder="Ex: Reunião com cliente" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--border-subtle); background:var(--bg-input); color:var(--text-primary);">
            </div>
            <div style="display:flex; gap:16px;">
                <div class="input-group" style="flex:1;">
                    <label style="display:block; margin-bottom:8px; font-size:14px; color:var(--text-secondary);">Data</label>
                    <input type="date" id="taskDate" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--border-subtle); background:var(--bg-input); color:var(--text-primary);">
                </div>
                <div class="input-group" style="flex:1;">
                    <label style="display:block; margin-bottom:8px; font-size:14px; color:var(--text-secondary);">Hora</label>
                    <input type="time" id="taskTime" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--border-subtle); background:var(--bg-input); color:var(--text-primary);">
                </div>
            </div>
            <div style="display:flex; justify-content:flex-end; margin-top:24px;">
                <button class="btn-primary" onclick="submitTask()">Criar Tarefa</button>
            </div>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="projectModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10002; align-items:center; justify-content:center;">
        <div class="card" style="width:90%; max-width:500px;">
            <div class="card-header">
                <h3 class="card-title">Novo Projeto</h3>
                <button onclick="closeModal('projectModal')" style="background:none; border:none; color:var(--text-secondary); cursor:pointer;"><span class="material-icons-round">close</span></button>
            </div>
            <div class="input-group">
                <label style="display:block; margin-bottom:8px; font-size:14px; color:var(--text-secondary);">Nome do Projeto</label>
                <input type="text" id="projName" placeholder="Ex: Lançamento Website" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--border-subtle); background:var(--bg-input); color:var(--text-primary);">
            </div>
            <div class="input-group">
                <label style="display:block; margin-bottom:8px; font-size:14px; color:var(--text-secondary);">Descrição</label>
                <textarea id="projDesc" rows="3" placeholder="Detalhes do projeto..." style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--border-subtle); background:var(--bg-input); color:var(--text-primary); font-family:var(--font-body);"></textarea>
            </div>
            <div style="display:flex; justify-content:flex-end; margin-top:24px;">
                <button class="btn-primary" onclick="submitProject()">Criar Projeto</button>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10002; align-items:center; justify-content:center;">
        <div class="card" style="width:90%; max-width:500px;">
            <div class="card-header">
                <h3 class="card-title">Editar Perfil</h3>
                <button onclick="closeModal('editProfileModal')" style="background:none; border:none; color:var(--text-secondary); cursor:pointer;"><span class="material-icons-round">close</span></button>
            </div>
            <div class="input-group">
                <label style="display:block; margin-bottom:8px; font-size:14px; color:var(--text-secondary);">Nome</label>
                <input type="text" id="profileName" placeholder="Seu nome" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--border-subtle); background:var(--bg-input); color:var(--text-primary);">
            </div>
            <div class="input-group">
                <label style="display:block; margin-bottom:8px; font-size:14px; color:var(--text-secondary);">Fuso Horário</label>
                <input type="text" id="profileTimezone" placeholder="Ex: America/Sao_Paulo" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--border-subtle); background:var(--bg-input); color:var(--text-primary);">
            </div>
            <div class="input-group">
                <label style="display:block; margin-bottom:8px; font-size:14px; color:var(--text-secondary);">Localização</label>
                <input type="text" id="profileLocale" placeholder="Ex: São Paulo, BR" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--border-subtle); background:var(--bg-input); color:var(--text-primary);">
            </div>
            <div style="display:flex; justify-content:flex-end; margin-top:24px;">
                <button class="btn-primary" onclick="submitProfileEdit()">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div id="editTaskModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10002; align-items:center; justify-content:center;">
        <div class="card" style="width:90%; max-width:500px;">
            <div class="card-header">
                <h3 class="card-title">Editar Tarefa</h3>
                <button onclick="closeModal('editTaskModal')" style="background:none; border:none; color:var(--text-secondary); cursor:pointer;"><span class="material-icons-round">close</span></button>
            </div>
            <input type="hidden" id="editTaskId">
            <div class="input-group">
                <label style="display:block; margin-bottom:8px; font-size:14px; color:var(--text-secondary);">Descrição</label>
                <input type="text" id="editTaskDesc" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--border-subtle); background:var(--bg-input); color:var(--text-primary);">
            </div>
            <div style="display:flex; gap:16px;">
                <div class="input-group" style="flex:1;">
                    <label style="display:block; margin-bottom:8px; font-size:14px; color:var(--text-secondary);">Data</label>
                    <input type="date" id="editTaskDate" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--border-subtle); background:var(--bg-input); color:var(--text-primary);">
                </div>
                <div class="input-group" style="flex:1;">
                    <label style="display:block; margin-bottom:8px; font-size:14px; color:var(--text-secondary);">Hora</label>
                    <input type="time" id="editTaskTime" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--border-subtle); background:var(--bg-input); color:var(--text-primary);">
                </div>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:24px;">
                <button class="btn-secondary" style="color:var(--status-error); border-color:var(--status-error);" onclick="deleteTaskFromModal()">Excluir</button>
                <button class="btn-primary" onclick="submitEditTask()">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <!-- Routine Modal -->
    <div id="routineModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10002; align-items:center; justify-content:center;">
        <div class="card" style="width:90%; max-width:600px;">
            <div class="card-header">
                <h3 class="card-title">Nova Rotina</h3>
                <button onclick="closeModal('routineModal')" style="background:none; border:none; color:var(--text-secondary); cursor:pointer;"><span class="material-icons-round">close</span></button>
            </div>
            <div class="input-group">
                <label style="display:block; margin-bottom:8px; font-size:14px; color:var(--text-secondary);">Nome da Rotina</label>
                <input type="text" id="routineName" placeholder="Ex: Rotina Matinal" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--border-subtle); background:var(--bg-input); color:var(--text-primary);">
            </div>
            <div class="input-group">
                <label style="display:block; margin-bottom:8px; font-size:14px; color:var(--text-secondary);">Descrição</label>
                <input type="text" id="routineDesc" placeholder="Ex: Foco e exercícios" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--border-subtle); background:var(--bg-input); color:var(--text-primary);">
            </div>
            <div class="input-group">
                <label style="display:block; margin-bottom:8px; font-size:14px; color:var(--text-secondary);">Itens da Rotina (Um por linha: HH:MM - Descrição)</label>
                <textarea id="routineItems" rows="5" placeholder="08:00 - Café da manhã&#10;09:00 - Deep Work" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--border-subtle); background:var(--bg-input); color:var(--text-primary); font-family:var(--font-body);"></textarea>
            </div>
            <div style="display:flex; justify-content:flex-end; margin-top:24px;">
                <button class="btn-primary" onclick="submitRoutine()">Criar Rotina</button>
            </div>
        </div>
    </div>

    <!-- Speed Dial (FAB) -->
    <div class="speed-dial" id="speedDial">
        <div class="fab-options" id="fabOptions">
            <div class="fab-option" onclick="quickTaskCapture()">
                <span class="material-icons-round">add_task</span>
                <span>Tarefa Rápida</span>
            </div>
            <div class="fab-option" onclick="quickVoiceNote()">
                <span class="material-icons-round">mic</span>
                <span>Nota de Voz</span>
            </div>
            <div class="fab-option" onclick="quickMoodLog()">
                <span class="material-icons-round">mood</span>
                <span>Registrar Humor</span>
            </div>
        </div>
        <button class="fab-main" id="fabMain" onclick="toggleSpeedDial()">
            <span class="material-icons-round">add</span>
        </button>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    
    <script>
        // --- CONFIGURATION ---
        const config = {
            CLOUD_FUNCTION_URL: "https://eixa-api-760851989407.us-east1.run.app/interact",
            CLOUD_FUNCTION_ACTION_URL: "https://eixa-api-760851989407.us-east1.run.app/actions",
            CLOUD_FUNCTION_AUTH_URL: "https://eixa-api-760851989407.us-east1.run.app/auth/google",
            CLOUD_FUNCTION_OAUTH_CALLBACK_URL: "https://eixa-api-760851989407.us-east1.run.app/oauth2callback",
            firebaseConfig: {
                apiKey: "AIzaSyAKEdwGJFjAXyY3vQUMm0sCIvdSfs-WInw",
                authDomain: "arquitetodadivulgacao.firebaseapp.com",
                projectId: "arquitetodadivulgacao",
                storageBucket: "arquitetodadivulgacao.firebasestorage.app",
                messagingSenderId: "760851989407",
                appId: "1:760851989407:web:485fc9e2d0328b479473aa"
            },
            MAX_FILE_SIZE: 10 * 1024 * 1024
        };

        let currentUser = null;
        let currentFileUpload = null;

        // --- MODAL LOGIC ---
        function openModal(id) {
            document.getElementById(id).style.display = 'flex';
            if(id === 'taskModal') {
                document.getElementById('taskDate').valueAsDate = new Date();
            }
        }
        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function openEditTaskModal(dateStr, task) {
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('editTaskDesc').value = task.description;
            document.getElementById('editTaskDate').value = dateStr;
            document.getElementById('editTaskTime').value = task.time;
            openModal('editTaskModal');
        }

        // --- CRUD ACTIONS ---
        async function submitTask() {
            const desc = document.getElementById('taskDesc').value;
            const date = document.getElementById('taskDate').value;
            const time = document.getElementById('taskTime').value;
            
            if(!desc || !date) {
                showToast('Preencha descrição e data', 'error');
                return;
            }

            showGlobalLoader();
            const payload = {
                request_type: 'crud_action',
                item_type: 'task',
                action: 'create',
                date: date,
                data: {
                    description: desc,
                    time: time || '09:00',
                    duration_minutes: 60
                }
            };

            const res = await callBackendAPI(payload);
            hideGlobalLoader();
            
            if(res.status !== 'error') {
                showToast('Tarefa criada com sucesso!', 'success');
                closeModal('taskModal');
                loadViewData('agenda'); // Refresh
            } else {
                showToast('Erro ao criar tarefa: ' + res.message, 'error');
            }
        }

        async function submitEditTask() {
            const id = document.getElementById('editTaskId').value;
            const desc = document.getElementById('editTaskDesc').value;
            const date = document.getElementById('editTaskDate').value;
            const time = document.getElementById('editTaskTime').value;

            showGlobalLoader();
            const payload = {
                request_type: 'crud_action',
                item_type: 'task',
                action: 'update',
                item_id: id,
                date: date,
                data: {
                    description: desc,
                    time: time
                }
            };
            const res = await callBackendAPI(payload);
            hideGlobalLoader();
            if(res.status !== 'error') {
                showToast('Tarefa atualizada!', 'success');
                closeModal('editTaskModal');
                loadViewData('agenda');
            } else {
                showToast('Erro: ' + res.message, 'error');
            }
        }

        async function deleteTaskFromModal() {
            const id = document.getElementById('editTaskId').value;
            if(!confirm('Tem certeza que deseja excluir esta tarefa?')) return;

            showGlobalLoader();
            const payload = {
                request_type: 'crud_action',
                item_type: 'task',
                action: 'delete',
                item_id: id
            };
            const res = await callBackendAPI(payload);
            hideGlobalLoader();
            if(res.status !== 'error') {
                showToast('Tarefa excluída!', 'success');
                closeModal('editTaskModal');
                loadViewData('agenda');
            } else {
                showToast('Erro: ' + res.message, 'error');
            }
        }

        async function submitRoutine() {
            const name = document.getElementById('routineName').value;
            const desc = document.getElementById('routineDesc').value;
            const itemsText = document.getElementById('routineItems').value;

            if(!name) { showToast('Nome da rotina obrigatório', 'error'); return; }

            // Parse items
            const schedule = [];
            const lines = itemsText.split('\n');
            lines.forEach(line => {
                const parts = line.split('-');
                if(parts.length >= 2) {
                    schedule.push({
                        time: parts[0].trim(),
                        description: parts.slice(1).join('-').trim(),
                        duration_minutes: 60,
                        type: 'task'
                    });
                }
            });

            showGlobalLoader();
            const payload = {
                request_type: 'crud_action',
                item_type: 'routine',
                action: 'create',
                data: {
                    name: name,
                    description: desc,
                    schedule: schedule,
                    recurrence_rule: 'daily' // Default
                }
            };
            const res = await callBackendAPI(payload);
            hideGlobalLoader();
            if(res.status !== 'error') {
                showToast('Rotina criada!', 'success');
                closeModal('routineModal');
                loadViewData('rotinas_templates_view');
            } else {
                showToast('Erro: ' + res.message, 'error');
            }
        }

        async function applyRoutine(routineId) {
            if(!confirm('Aplicar esta rotina para hoje?')) return;
            showGlobalLoader();
            const payload = {
                request_type: 'crud_action',
                item_type: 'routine',
                action: 'apply_routine',
                item_id: routineId,
                date: new Date().toISOString().split('T')[0]
            };
            const res = await callBackendAPI(payload);
            hideGlobalLoader();
            if(res.status !== 'error') {
                showToast('Rotina aplicada!', 'success');
                switchView('agenda');
            } else {
                showToast('Erro: ' + res.message, 'error');
            }
        }

        async function deleteRoutine(routineId) {
            if(!confirm('Tem certeza que deseja excluir esta rotina?')) return;
            showGlobalLoader();
            const payload = {
                request_type: 'crud_action',
                item_type: 'routine',
                action: 'delete',
                item_id: routineId
            };
            const res = await callBackendAPI(payload);
            hideGlobalLoader();
            if(res.status !== 'error') {
                showToast('Rotina excluída!', 'success');
                loadViewData('rotinas_templates_view');
            } else {
                showToast('Erro: ' + res.message, 'error');
            }
        }

        async function submitProject() {
            const name = document.getElementById('projName').value;
            const desc = document.getElementById('projDesc').value;
            
            if(!name) {
                showToast('Nome do projeto é obrigatório', 'error');
                return;
            }

            showGlobalLoader();
            const payload = {
                request_type: 'crud_action',
                item_type: 'project',
                action: 'create',
                data: {
                    name: name,
                    description: desc,
                    status: 'active'
                }
            };

            const res = await callBackendAPI(payload);
            hideGlobalLoader();
            
            if(res.status !== 'error') {
                showToast('Projeto criado com sucesso!', 'success');
                closeModal('projectModal');
                loadViewData('projects'); // Refresh
            } else {
                showToast('Erro ao criar projeto: ' + res.message, 'error');
            }
        }

        // --- UI HELPERS ---
        function showGlobalLoader() {
            document.getElementById('globalLoader').classList.remove('hidden');
        }
        function hideGlobalLoader() {
            document.getElementById('globalLoader').classList.add('hidden');
        }
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.style.padding = '12px 24px';
            toast.style.borderRadius = '8px';
            toast.style.color = 'white';
            toast.style.fontWeight = '500';
            toast.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
            toast.style.animation = 'fadeIn 0.3s ease';
            
            if (type === 'error') toast.style.backgroundColor = 'var(--status-error)';
            else if (type === 'success') toast.style.backgroundColor = 'var(--status-success)';
            else toast.style.backgroundColor = 'var(--accent-primary)';
            
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- MOBILE: Swipe & History State ---
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;
        let pullStartY = 0;
        let isPulling = false;
        const viewHistory = [];
        let currentViewIndex = -1;

        // --- VIEW SWITCHING ---
        function switchView(viewName) {
            // Push to history (for back button navigation)
            if (currentViewIndex < viewHistory.length - 1) {
                viewHistory.splice(currentViewIndex + 1);
            }
            viewHistory.push(viewName);
            currentViewIndex = viewHistory.length - 1;
            
            // Update browser history (History API)
            if (window.history.pushState) {
                window.history.pushState({ view: viewName }, '', `#${viewName}`);
            }
            
            // Hide all views
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            // Show target view
            const target = document.getElementById('view-' + viewName);
            if (target) target.classList.add('active');
            
            // Update sidebar active state
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const navItem = document.querySelector(`.nav-item[data-target="${viewName}"]`);
            if (navItem) navItem.classList.add('active');

            // Load data if needed
            if (viewName !== 'chat') {
                loadViewData(viewName);
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const icons = document.querySelectorAll('.theme-toggle span');
            const isDark = document.body.classList.contains('dark-mode');
            icons.forEach(icon => icon.textContent = isDark ? 'light_mode' : 'dark_mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        function connectGoogleCalendar() {
            if (!currentUser) {
                showToast('Você precisa estar logado.', 'error');
                return;
            }
            // Redirect to backend auth endpoint
            const authUrl = `${config.CLOUD_FUNCTION_AUTH_URL}?user_id=${currentUser.uid}`;
            window.location.href = authUrl;
        }

        function toggleCalendarView(type) {
            const weekView = document.getElementById('agenda-week');
            const monthView = document.getElementById('agenda-month');
            const routinesView = document.getElementById('agenda-routines');
            const buttons = document.querySelectorAll('.view-toggle');

            // Reset all
            weekView.style.display = 'none';
            monthView.style.display = 'none';
            routinesView.style.display = 'none';
            buttons.forEach(b => b.classList.remove('active'));

            if(type === 'week') {
                weekView.style.display = 'flex';
                buttons[0].classList.add('active');
            } else if(type === 'month') {
                monthView.style.display = 'block';
                buttons[1].classList.add('active');
            } else if(type === 'routines') {
                routinesView.style.display = 'block';
                buttons[2].classList.add('active');
                loadViewData('rotinas_templates_view');
            }
        }

        // --- DATA LOADING & RENDERING ---
        async function callBackendAPI(payload) {
            if (!currentUser) return { status: 'error', response: 'Usuário não autenticado.' };
            
            payload.user_id = currentUser.uid;
            const endpoint = payload.request_type === 'crud_action' ? config.CLOUD_FUNCTION_ACTION_URL : config.CLOUD_FUNCTION_URL;
            
            try {
                const token = await currentUser.getIdToken();
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                return data.response_payload || data;
            } catch (e) {
                console.error("API Error:", e);
                return { status: 'error', response: e.message };
            }
        }

        async function loadViewData(viewName) {
            showGlobalLoader();
            const payload = { request_type: 'chat_and_view', view_request: viewName };
            const data = await callBackendAPI(payload);
            hideGlobalLoader();

            if (data.status === 'success' && data.html_view_data) {
                if (viewName === 'dashboard') renderDashboard(data.html_view_data.dashboard);
                if (viewName === 'agenda') renderAgenda(data.html_view_data.agenda);
                if (viewName === 'projects') renderProjects(data.html_view_data.projetos);
                if (viewName === 'memories') renderMemories(data.html_view_data.emotional_memories);
                if (viewName === 'diagnostico') renderDiagnosis(data.html_view_data.diagnostico);
                if (viewName === 'profile') renderProfile(data.html_view_data.long_term_memory);
                if (viewName === 'rotinas_templates_view') renderRoutines(data.html_view_data.routines);
            }
        }

        function renderDashboard(data) {
            const container = document.getElementById('dashboard-content');
            if (!data) return;

            const greeting = data.greeting || {};
            const focus = data.focus_task;
            const stats = data.stats || {};

            let focusHtml = '';
            if (focus) {
                focusHtml = `
                    <div class="bento-item bento-large focus-widget">
                        <div>
                            <h3>Foco Agora</h3>
                            <div class="focus-task-title">${focus.description}</div>
                            <div style="font-size:14px; opacity:0.8;">${focus.time || 'Hoje'}</div>
                        </div>
                        <div style="display:flex; justify-content:flex-end;">
                            <button class="btn-secondary" style="background:rgba(255,255,255,0.2); color:white; border:none;" onclick="switchView('agenda')">Ver Agenda</button>
                        </div>
                    </div>
                `;
            } else {
                focusHtml = `
                    <div class="bento-item bento-large focus-widget" style="background: linear-gradient(135deg, var(--status-success), #059669);">
                        <div>
                            <h3>Tudo Limpo!</h3>
                            <div class="focus-task-title">Você está livre.</div>
                            <div style="font-size:14px; opacity:0.8;">Aproveite seu tempo.</div>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="greeting-widget" style="margin-bottom:24px;">
                    <h2>${greeting.greeting_time}, ${greeting.user_name.split(' ')[0]}.</h2>
                    <div class="weather-pill">
                        <span class="material-icons-round" style="font-size:16px;">fact_check</span>
                        <span>${greeting.status_hint || greeting.weather_hint || ''}</span>
                    </div>
                </div>

                <div class="bento-grid">
                    ${focusHtml}
                    
                    <div class="bento-item stats-widget">
                        <h3>Produtividade</h3>
                        <div style="margin-top:16px;">
                            <div class="stats-circle" style="background: conic-gradient(var(--accent-primary) ${stats.today_completion || 0}%, var(--bg-input) 0% 100%);">
                                <span class="stats-value">${stats.today_completion || 0}%</span>
                            </div>
                            <p style="font-size:12px; color:var(--text-secondary);">${stats.completed_tasks || 0}/${stats.total_tasks || 0} tarefas</p>
                        </div>
                    </div>

                    <div class="bento-item" onclick="switchView('chat')" style="cursor:pointer;">
                        <div style="width:40px; height:40px; background:var(--accent-light); border-radius:12px; display:flex; align-items:center; justify-content:center; color:var(--accent-primary); margin-bottom:12px;">
                            <span class="material-icons-round">chat</span>
                        </div>
                        <div>
                            <h4 style="font-size:16px; font-weight:700;">Chat IA</h4>
                            <p style="font-size:12px; color:var(--text-secondary);">Nova conversa</p>
                        </div>
                    </div>

                    <div class="bento-item" onclick="openModal('taskModal')" style="cursor:pointer;">
                        <div style="width:40px; height:40px; background:var(--bg-input); border-radius:12px; display:flex; align-items:center; justify-content:center; color:var(--text-primary); margin-bottom:12px;">
                            <span class="material-icons-round">add_task</span>
                        </div>
                        <div>
                            <h4 style="font-size:16px; font-weight:700;">Quick Add</h4>
                            <p style="font-size:12px; color:var(--text-secondary);">Nova Tarefa</p>
                        </div>
                    </div>
                    
                    <div class="bento-item" onclick="switchView('projects')" style="cursor:pointer;">
                        <div style="width:40px; height:40px; background:var(--bg-input); border-radius:12px; display:flex; align-items:center; justify-content:center; color:var(--text-primary); margin-bottom:12px;">
                            <span class="material-icons-round">folder</span>
                        </div>
                        <div>
                            <h4 style="font-size:16px; font-weight:700;">Projetos</h4>
                            <p style="font-size:12px; color:var(--text-secondary);">Ver todos</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderKanban(data) {
            const container = document.getElementById('kanban-board');
            if (!container) return;
            container.innerHTML = '';

            if (!data) {
                container.innerHTML = '<p style="color:var(--text-secondary);">Nenhum dado para o Kanban.</p>';
                return;
            }

            const projects = data.projects || [];
            const tasks = data.tasks || [];

            // Define columns
            const columns = [
                { id: 'todo', title: 'A Fazer', color: 'var(--text-secondary)' },
                { id: 'in_progress', title: 'Em Progresso', color: 'var(--accent-primary)' },
                { id: 'done', title: 'Concluído', color: 'var(--status-success)' }
            ];

            // Create column elements
            columns.forEach(col => {
                const colDiv = document.createElement('div');
                colDiv.className = 'kanban-column';
                colDiv.innerHTML = `
                    <div class="kanban-header" style="border-top: 3px solid ${col.color};">
                        <h3>${col.title}</h3>
                        <span class="count" id="count-${col.id}">0</span>
                    </div>
                    <div class="kanban-items" id="col-${col.id}" ondrop="drop(event, '${col.id}')" ondragover="allowDrop(event)">
                        <!-- Items go here -->
                    </div>
                `;
                container.appendChild(colDiv);
            });

            // Distribute items
            let counts = { todo: 0, in_progress: 0, done: 0 };

            // Helper to add item
            const addItem = (item, type) => {
                // Normalize status
                let status = 'todo';
                if (type === 'project') {
                    if (item.status === 'completed') status = 'done';
                    else if (item.status === 'in_progress') status = 'in_progress';
                    else status = 'todo';
                } else {
                    // Task
                    if (item.status === 'done' || item.completed) status = 'done';
                    else if (item.status === 'in_progress') status = 'in_progress';
                    else status = 'todo';
                }

                counts[status]++;
                const colContainer = document.getElementById(`col-${status}`);
                
                const card = document.createElement('div');
                card.className = 'kanban-card';
                card.draggable = true;
                card.ondragstart = (e) => drag(e, type, item.id);
                
                let badge = type === 'project' ? '<span class="tag tag-purple">PROJETO</span>' : '<span class="tag tag-gray">TAREFA</span>';
                
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        ${badge}
                        <span style="font-size:10px; color:var(--text-tertiary);">${item.time || ''}</span>
                    </div>
                    <p style="font-weight:600; font-size:14px; margin-bottom:4px;">${item.name || item.description}</p>
                `;
                colContainer.appendChild(card);
            };

            projects.forEach(p => addItem(p, 'project'));
            tasks.forEach(t => addItem(t, 'task'));

            // Update counts
            Object.keys(counts).forEach(k => {
                document.getElementById(`count-${k}`).textContent = counts[k];
            });
        }

        // --- KANBAN DRAG & DROP ---
        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev, type, id) {
            ev.dataTransfer.setData("text/plain", JSON.stringify({type, id}));
        }

        async function drop(ev, newStatus) {
            ev.preventDefault();
            const data = JSON.parse(ev.dataTransfer.getData("text/plain"));
            
            // Optimistic UI update could go here, but for now let's just call backend
            showGlobalLoader();
            
            const payload = {
                request_type: 'update_kanban_status',
                action_data: {
                    item_type: data.type,
                    item_id: data.id,
                    new_status: newStatus
                }
            };

            const res = await callBackendAPI(payload);
            hideGlobalLoader();

            if (res.status === 'success') {
                // Reload Kanban to reflect changes
                if (res.html_view_data && res.html_view_data.kanban) {
                    renderKanban(res.html_view_data.kanban);
                } else {
                    loadViewData('kanban');
                }
                showToast('Status atualizado!', 'success');
            } else {
                showToast('Erro ao atualizar status.', 'error');
            }
        }

        function renderDiagnosis(data) {
            const container = document.getElementById('diagnostico-content');
            if (!data) {
                container.innerHTML = '<div class="card"><p style="color:var(--text-secondary);">Nenhum diagnóstico recente encontrado.</p></div>';
                return;
            }
            
            // Assuming data structure from backend/personal_checkpoint.py
            // It usually returns { "date": ..., "scores": { "focus": 8, ... }, "analysis": "..." }
            
            let scoresHtml = '';
            if (data.scores) {
                scoresHtml = '<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:16px; margin-bottom:24px;">';
                for (const [key, value] of Object.entries(data.scores)) {
                    scoresHtml += `
                        <div class="card" style="text-align:center; padding:16px;">
                            <div style="font-size:12px; text-transform:uppercase; color:var(--text-secondary); margin-bottom:8px;">${key}</div>
                            <div style="font-size:24px; font-weight:800; color:var(--accent-primary);">${value}/10</div>
                        </div>
                    `;
                }
                scoresHtml += '</div>';
            }

            container.innerHTML = `
                ${scoresHtml}
                <div class="card">
                    <h3 class="card-title" style="margin-bottom:16px;">Análise</h3>
                    <p style="line-height:1.6; color:var(--text-primary);">${(data.analysis || 'Sem análise textual.').replace(/\n/g, '<br>')}</p>
                    <div style="margin-top:16px; font-size:12px; color:var(--text-tertiary);">
                        Realizado em: ${data.date || 'Data desconhecida'}
                    </div>
                </div>
            `;
        }

        function renderAgenda(agendaData) {
            const weekContainer = document.getElementById('agenda-week');
            weekContainer.innerHTML = '';
            
            // Simple logic to show next 7 days
            const today = new Date();
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dateStr = date.toLocaleDateString('en-CA'); // YYYY-MM-DD
                const dayName = date.toLocaleDateString('pt-BR', { weekday: 'short' }).toUpperCase().replace('.', '');
                const dayNum = date.getDate();
                
                const dayData = agendaData[dateStr] || { tasks: [] };
                
                let tasksHtml = '';
                dayData.tasks.forEach(task => {
                    // Encode task data for edit
                    const taskJson = JSON.stringify(task).replace(/"/g, '&quot;');
                    
                    // Determine Badge & Card Class
                    let badgeHtml = '';
                    let cardClass = 'task-card'; // New Premium Class
                    
                    if (task.origin === 'google_calendar') {
                        badgeHtml = '<span class="badge badge-google"><span class="material-icons-round" style="font-size:10px;">event</span> GOOGLE</span>';
                        cardClass += ' origin-google';
                    } else if (task.origin === 'routine') {
                        badgeHtml = '<span class="badge badge-routine"><span class="material-icons-round" style="font-size:10px;">repeat</span> ROTINA</span>';
                        cardClass += ' origin-routine';
                    } else {
                        badgeHtml = '<span class="badge badge-eixa"><span class="material-icons-round" style="font-size:10px;">person</span> VOCÊ</span>';
                    }

                    tasksHtml += `
                        <div class="${cardClass}" style="cursor:pointer;" onclick="openEditTaskModal('${dateStr}', ${taskJson})">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                <span class="event-chip">${task.time}</span>
                                ${badgeHtml}
                            </div>
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <p style="font-size:14px; font-weight:600; margin:0; color:var(--text-primary);">${task.description}</p>
                                <span class="material-icons-round" style="font-size:16px; color:var(--text-tertiary);">edit</span>
                            </div>
                        </div>
                    `;
                });

                const col = document.createElement('div');
                col.className = 'day-column';
                col.innerHTML = `
                    <div class="day-col-header">
                        <span style="color:var(--text-secondary); font-size:12px;">${dayName}</span><br>
                        <span style="font-weight:700; font-size:18px; ${i===0 ? 'color:var(--accent-primary);' : ''}">${dayNum}</span>
                    </div>
                    ${tasksHtml || '<p style="font-size:12px; color:var(--text-tertiary); text-align:center;">Sem tarefas</p>'}
                `;
                weekContainer.appendChild(col);
            }
        }

        function renderRoutines(routines) {
            const container = document.getElementById('routines-list');
            container.innerHTML = '';
            if (!routines || routines.length === 0) {
                container.innerHTML = '<p style="color:var(--text-secondary); text-align:center;">Nenhuma rotina encontrada.</p>';
                return;
            }

            routines.forEach(r => {
                const itemsHtml = (r.schedule || []).map(item => `
                    <div class="routine-item-row">
                        <span style="font-weight:600; color:var(--accent-primary);">${item.time}</span>
                        <span>${item.description}</span>
                    </div>
                `).join('');

                const card = document.createElement('div');
                card.className = 'routine-card';
                card.innerHTML = `
                    <div class="routine-header">
                        <div>
                            <h3 style="font-size:16px; font-weight:700;">${r.name}</h3>
                            <p style="font-size:12px; color:var(--text-secondary);">${r.description || ''}</p>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn-secondary" style="padding:6px 12px; font-size:12px; color:var(--status-error); border-color:var(--status-error);" onclick="deleteRoutine('${r.id}')">Excluir</button>
                            <button class="btn-secondary" style="padding:6px 12px; font-size:12px;" onclick="applyRoutine('${r.id}')">Aplicar</button>
                        </div>
                    </div>
                    <div class="routine-items">
                        ${itemsHtml}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderProjects(projects) {
            const container = document.getElementById('projects-container');
            container.innerHTML = '';
            if (!projects || projects.length === 0) {
                container.innerHTML = '<p style="color:var(--text-secondary);">Nenhum projeto encontrado.</p>';
                return;
            }
            
            projects.forEach(p => {
                const progress = p.progress || 0; 
                const pJson = JSON.stringify(p).replace(/"/g, '&quot;');
                const card = document.createElement('div');
                card.className = 'card';
                card.style.cursor = 'pointer';
                card.onclick = () => openProjectDetails(p);
                card.innerHTML = `
                    <div class="card-header">
                        <span class="tag tag-purple">${p.status || 'Ativo'}</span>
                        <span class="material-icons-round" style="color:var(--text-tertiary);">arrow_forward</span>
                    </div>
                    <h3 class="card-title">${p.name}</h3>
                    <p style="font-size:14px; color:var(--text-secondary); margin-top:8px;">${p.description || ''}</p>
                    <div style="margin-top:24px;">
                        <div style="display:flex; justify-content:space-between; font-size:12px; font-weight:600;">
                            <span>Progresso</span>
                            <span>${progress}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${progress === 100 ? 'complete' : ''}" style="width: ${progress}%;"></div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function openProjectDetails(project) {
            switchView('project-details');
            const container = document.getElementById('project-detail-content');
            
            let tasksHtml = '';
            if (project.micro_tasks && project.micro_tasks.length > 0) {
                project.micro_tasks.forEach(task => {
                    const isCompleted = task.completed ? 'checked' : '';
                    const style = task.completed ? 'text-decoration: line-through; color: var(--text-tertiary);' : '';
                    tasksHtml += `
                        <div style="display:flex; align-items:center; padding:8px 0; border-bottom:1px solid var(--border-subtle);">
                            <input type="checkbox" ${isCompleted} disabled style="margin-right:12px;">
                            <span style="${style}">${task.description}</span>
                        </div>
                    `;
                });
            } else {
                tasksHtml = '<p style="color:var(--text-secondary); font-size:14px;">Nenhuma micro-tarefa definida.</p>';
            }

            container.innerHTML = `
                <div class="project-detail-header">
                    <h1 style="font-family:var(--font-display); font-size:28px; margin-bottom:8px;">${project.name}</h1>
                    <p style="color:var(--text-secondary); font-size:16px;">${project.description || 'Sem descrição'}</p>
                    <div style="margin-top:16px; display:flex; gap:12px;">
                        <span class="tag tag-purple">${project.status || 'Ativo'}</span>
                        <span class="tag tag-gray">ID: ${project.id}</span>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title" style="margin-bottom:16px;">Tarefas do Projeto</h3>
                    <div class="project-tasks-list">
                        ${tasksHtml}
                    </div>
                </div>
            `;
        }

        function renderMemories(memories) {
            const container = document.getElementById('memories-container');
            container.innerHTML = '';
            if (!memories || memories.length === 0) {
                container.innerHTML = '<p style="color:var(--text-secondary);">Nenhuma memória registrada.</p>';
                return;
            }
            
            memories.forEach(m => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.breakInside = 'avoid';
                card.innerHTML = `
                    <div style="font-size:12px; color:var(--text-tertiary); margin-bottom:8px;">${m.timestamp || 'Data desconhecida'}</div>
                    <p style="font-size:15px; font-style:italic; color:var(--text-secondary); line-height:1.6;">"${m.content}"</p>
                    <div class="trait-cloud" style="margin-top:16px;">
                        ${(m.tags || []).map(t => `<span class="tag tag-gray">${t}</span>`).join('')}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderProfile(profileData) {
            const container = document.getElementById('profile-content');
            if (!profileData) return;
            
            // Helper to render list
            const renderList = (items) => (items || []).map(i => `<li class="info-row"><span class="info-value">${i}</span></li>`).join('');

            container.innerHTML = `
                <div>
                    <div class="card">
                        <h3 class="card-title">Informações Essenciais</h3>
                        <div class="profile-section-title">Localização</div>
                        <div class="info-row"><span class="info-label">Local</span><span class="info-value">${profileData.locale || 'N/A'}</span></div>
                        <div class="info-row"><span class="info-label">Fuso</span><span class="info-value">${profileData.timezone || 'N/A'}</span></div>
                    </div>
                    <div class="card">
                        <h3 class="card-title">Estilo Cognitivo</h3>
                        <ul style="list-style:none; padding:0;">${renderList(profileData.cognitive_style)}</ul>
                    </div>
                </div>
                <div>
                    <div class="card">
                        <h3 class="card-title">Psicológico</h3>
                        <div class="profile-section-title">Traços</div>
                        <div class="trait-cloud">
                            ${(profileData.personality_traits || []).map(t => `<span class="tag tag-gray">${t}</span>`).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- CHAT LOGIC ---
        function parseMarkdownToHtml(markdown) {
            if (!markdown) return '';
            
            // Basic HTML Escape
            let html = markdown
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");

            // Code Blocks
            html = html.replace(/```([\s\S]*?)```/g, (match, code) => {
                return '<pre><code>' + code.replace(/&lt;/g, '<').replace(/&gt;/g, '>') + '</code></pre>';
            });

            // Inline Code
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

            // Bold
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Italic
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // Links
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

            // Headers
            html = html.replace(/^### (.*$)/gm, '<h4>$1</h4>');
            html = html.replace(/^## (.*$)/gm, '<h3>$1</h3>');
            html = html.replace(/^# (.*$)/gm, '<h2>$1</h2>');

            // Lists
            html = html.replace(/^\- (.*$)/gm, '<li>$1</li>');
            
            // Newlines (avoiding pre blocks)
            const parts = html.split(/(<pre>[\s\S]*?<\/pre>)/g);
            html = parts.map(part => {
                if (part.startsWith('<pre>')) return part;
                return part.replace(/\n/g, '<br>');
            }).join('');

            return html;
        }

        // --- RICH UI RENDERER ---
        function renderRichComponent(data) {
            const type = data.type;
            let html = '';

            if (type === 'calendar_invite') {
                html = `
                    <div class="rich-component calendar-invite">
                        <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
                            <span class="material-icons-round" style="color:var(--accent-primary);">event</span>
                            <h4 style="margin:0;">${data.title || 'Convite de Evento'}</h4>
                        </div>
                        <div style="background:var(--bg-input); padding:12px; border-radius:8px; margin-bottom:12px;">
                            <p style="margin:4px 0;"><strong>Data:</strong> ${data.date || 'N/A'}</p>
                            <p style="margin:4px 0;"><strong>Horário:</strong> ${data.time || 'N/A'}</p>
                            ${data.location ? `<p style="margin:4px 0;"><strong>Local:</strong> ${data.location}</p>` : ''}
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn-reject" onclick="this.closest('.rich-component').remove()">Recusar</button>
                            <button class="btn-accept" onclick="acceptCalendarInvite(this, ${JSON.stringify(data).replace(/"/g, '&quot;')})">Aceitar</button>
                        </div>
                    </div>
                `;
            } else if (type === 'chart') {
                html = `
                    <div class="rich-component chart-widget">
                        <h4>${data.title || 'Gráfico'}</h4>
                        <div style="background:var(--bg-input); padding:16px; border-radius:8px; text-align:center;">
                            <span class="material-icons-round" style="font-size:48px; color:var(--accent-primary);">insert_chart</span>
                            <p style="margin-top:8px; color:var(--text-secondary);">Dados: ${data.summary || 'N/A'}</p>
                        </div>
                    </div>
                `;
            } else if (type === 'quick_action') {
                html = `
                    <div class="rich-component quick-action">
                        <button class="btn-primary" onclick="${data.action || 'alert("Ação não definida")'}"
                                style="width:100%; justify-content:center; padding:16px;">
                            <span class="material-icons-round">${data.icon || 'touch_app'}</span>
                            <span style="margin-left:8px;">${data.label || 'Ação'}</span>
                        </button>
                    </div>
                `;
            }

            return html;
        }

        async function acceptCalendarInvite(btn, data) {
            btn.textContent = 'Adicionando...';
            btn.disabled = true;
            
            const payload = {
                request_type: 'crud_action',
                item_type: 'task',
                action: 'create',
                date: data.date,
                data: {
                    description: data.title,
                    time: data.time || '09:00',
                    duration_minutes: data.duration || 60
                }
            };
            
            const res = await callBackendAPI(payload);
            if (res.status !== 'error') {
                showToast('Evento adicionado à agenda!', 'success');
                btn.closest('.rich-component').remove();
            } else {
                showToast('Erro ao adicionar evento', 'error');
                btn.textContent = 'Aceitar';
                btn.disabled = false;
            }
        }

        async function handleSendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            if (!message && !currentFileUpload) return;

            // Render User Message
            const chatDisplay = document.getElementById('chat-display');
            const userMsgDiv = document.createElement('div');
            userMsgDiv.className = 'message message-user';
            
            if (currentFileUpload) {
                const isImage = currentFileUpload.mime_type && currentFileUpload.mime_type.startsWith('image/');
                if (isImage && currentFileUpload.base64_content) {
                    // Show image preview
                    const imgPreview = `<img src="data:${currentFileUpload.mime_type};base64,${currentFileUpload.base64_content}" alt="${currentFileUpload.filename}" style="max-width:200px; border-radius:8px; margin-top:8px; display:block;">`;
                    userMsgDiv.innerHTML = `${message || 'Imagem enviada'}${imgPreview}`;
                } else {
                    userMsgDiv.textContent = `${message} [Arquivo: ${currentFileUpload.filename}]`;
                }
            } else {
                userMsgDiv.textContent = message;
            }
            
            chatDisplay.appendChild(userMsgDiv);
            input.value = '';
            chatDisplay.scrollTop = chatDisplay.scrollHeight;

            // Prepare Payload
            const payload = {
                request_type: 'chat_and_view',
                message: message,
                uploaded_file_data: currentFileUpload
            };
            currentFileUpload = null;
            document.querySelector('.attachment-info').style.display = 'none';
            document.getElementById('fileUploadBtn').style.display = 'block';

            // Show Loading
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message message-ai';
            loadingDiv.id = 'ai-loading';
            loadingDiv.innerHTML = `
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            chatDisplay.appendChild(loadingDiv);
            chatDisplay.scrollTop = chatDisplay.scrollHeight;

            // Call API
            const response = await callBackendAPI(payload);
            
            // Remove Loading
            document.getElementById('ai-loading').remove();

            // Render AI Response
            const aiMsgDiv = document.createElement('div');
            aiMsgDiv.className = 'message message-ai';
            
            // Check if response contains Rich UI data
            let responseText = response.response || 'Erro ao processar.';
            let richComponents = '';
            
            // Try to extract JSON blocks for Rich UI
            const richUIPattern = /```rich-ui\s*({[\s\S]*?})\s*```/g;
            let match;
            while ((match = richUIPattern.exec(responseText)) !== null) {
                try {
                    const richData = JSON.parse(match[1]);
                    richComponents += renderRichComponent(richData);
                    responseText = responseText.replace(match[0], ''); // Remove from text
                } catch (e) {
                    console.error('Failed to parse Rich UI JSON:', e);
                }
            }
            
            aiMsgDiv.innerHTML = `<strong>EIXA</strong><br>${parseMarkdownToHtml(responseText)}${richComponents}`;
            
            // Check for image attachments in response
            if (response.image_url) {
                const imgHtml = `<div style="margin-top:12px;"><img src="${response.image_url}" alt="Imagem" style="max-width:100%; border-radius:12px; border:1px solid var(--border-subtle);"></div>`;
                aiMsgDiv.innerHTML += imgHtml;
            }
            
            chatDisplay.appendChild(aiMsgDiv);

            // Render Suggestions
            if (response.suggested_tasks && response.suggested_tasks.length > 0) {
                renderSuggestions(response.suggested_tasks, chatDisplay);
            }

            chatDisplay.scrollTop = chatDisplay.scrollHeight;
        }

        function renderSuggestions(tasks, container) {
            const suggestionsDiv = document.createElement('div');
            suggestionsDiv.className = 'suggestions-container';
            
            tasks.forEach(task => {
                const card = document.createElement('div');
                card.className = 'suggestion-card';
                // Encode task data to pass to function
                const taskJson = JSON.stringify(task).replace(/"/g, '&quot;');
                
                card.innerHTML = `
                    <div class="suggestion-info">
                        <h4>${task.description}</h4>
                        <p>${task.date || 'Hoje'} • ${task.time || 'Sem horário'}</p>
                    </div>
                    <div class="suggestion-actions">
                        <button class="btn-reject" onclick="this.closest('.suggestion-card').remove()">Rejeitar</button>
                        <button class="btn-accept" onclick="acceptTask(this, ${taskJson})">Aceitar</button>
                    </div>
                `;
                suggestionsDiv.appendChild(card);
            });
            
            container.appendChild(suggestionsDiv);
        }

        async function acceptTask(btn, task) {
            const card = btn.closest('.suggestion-card');
            btn.textContent = 'Aceitando...';
            btn.disabled = true;
            
            // Construct payload for create task
            const payload = {
                request_type: 'crud',
                action: 'create',
                item_type: 'task',
                data: {
                    description: task.description,
                    date: task.date || new Date().toISOString().split('T')[0],
                    time: task.time || '00:00',
                    duration_minutes: task.duration_minutes || 30
                }
            };

            const res = await callBackendAPI(payload);
            if (res.status === 'success') {
                card.innerHTML = `<div style="color:var(--status-success); font-weight:600; padding:8px;">Tarefa criada com sucesso!</div>`;
                setTimeout(() => card.remove(), 2000);
            } else {
                btn.textContent = 'Erro';
                showToast('Erro ao criar tarefa: ' + res.response, 'error');
            }
        }

        function openEditProfileModal() {
            // Pre-fill with current values if available
            const nameDisplay = document.getElementById('profile-name-display');
            if(nameDisplay) document.getElementById('profileName').value = nameDisplay.textContent;
            
            openModal('editProfileModal');
        }

        async function submitProfileEdit() {
            const name = document.getElementById('profileName').value;
            const timezone = document.getElementById('profileTimezone').value;
            const locale = document.getElementById('profileLocale').value;
            
            if(!name) { showToast('Nome é obrigatório', 'error'); return; }

            showGlobalLoader();
            
            // Direct update request
            const payload = {
                request_type: 'update_profile',
                action_data: {
                    name: name,
                    timezone: timezone,
                    locale: locale
                }
            };
            
            const res = await callBackendAPI(payload);
            hideGlobalLoader();
            
            if(res.status !== 'error') {
                showToast('Perfil atualizado!', 'success');
                closeModal('editProfileModal');
                loadViewData('profile');
            } else {
                showToast('Erro ao atualizar: ' + res.response, 'error');
            }
        }

        // --- SPEED DIAL FUNCTIONS ---
        function toggleSpeedDial() {
            const fabMain = document.getElementById('fabMain');
            const fabOptions = document.getElementById('fabOptions');
            
            fabMain.classList.toggle('active');
            fabOptions.classList.toggle('active');
        }

        function quickTaskCapture() {
            toggleSpeedDial();
            const taskDesc = prompt('Descreva sua tarefa rapidamente:');
            if (!taskDesc) return;
            
            showGlobalLoader();
            const today = new Date().toISOString().split('T')[0];
            
            const payload = {
                request_type: 'crud_action',
                item_type: 'task',
                action: 'create',
                date: today,
                data: {
                    description: taskDesc,
                    time: '09:00',
                    duration_minutes: 60
                }
            };
            
            callBackendAPI(payload).then(res => {
                hideGlobalLoader();
                if (res.status !== 'error') {
                    showToast('Tarefa criada!', 'success');
                    loadViewData('agenda');
                } else {
                    showToast('Erro ao criar tarefa', 'error');
                }
            });
        }

        function quickVoiceNote() {
            toggleSpeedDial();
            
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showToast('Seu navegador não suporta reconhecimento de voz', 'error');
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            recognition.lang = 'pt-BR';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            showToast('Gravando... fale agora!', 'info');
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('message-input').value = transcript;
                showToast('Transcrição concluída!', 'success');
            };
            
            recognition.onerror = (event) => {
                showToast('Erro ao gravar: ' + event.error, 'error');
            };
            
            recognition.start();
        }

        function quickMoodLog() {
            toggleSpeedDial();
            const mood = prompt('Como você está se sentindo? (1-10)');
            if (!mood || isNaN(mood) || mood < 1 || mood > 10) {
                showToast('Digite um número entre 1 e 10', 'error');
                return;
            }
            
            const note = prompt('Alguma observação sobre seu humor?');
            const message = `Registrar humor: ${mood}/10. ${note || ''}`;
            
            document.getElementById('message-input').value = message;
            handleSendMessage();
        }

        // --- MOBILE: SWIPE GESTURES ---
        function handleTouchStart(e) {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        }

        function handleTouchEnd(e) {
            touchEndX = e.changedTouches[0].screenX;
            touchEndY = e.changedTouches[0].screenY;
            handleSwipeGesture();
        }

        function handleSwipeGesture() {
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            const threshold = 100;
            
            // Horizontal swipe (view navigation)
            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > threshold) {
                if (deltaX > 0) {
                    // Swipe right - go back
                    navigateBack();
                } else {
                    // Swipe left - go forward (if available)
                    navigateForward();
                }
            }
        }

        function navigateBack() {
            if (currentViewIndex > 0) {
                currentViewIndex--;
                const previousView = viewHistory[currentViewIndex];
                switchViewDirect(previousView);
            }
        }

        function navigateForward() {
            if (currentViewIndex < viewHistory.length - 1) {
                currentViewIndex++;
                const nextView = viewHistory[currentViewIndex];
                switchViewDirect(nextView);
            }
        }

        function switchViewDirect(viewName) {
            // Direct switch without adding to history
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            const target = document.getElementById('view-' + viewName);
            if (target) target.classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const navItem = document.querySelector(`.nav-item[data-target="${viewName}"]`);
            if (navItem) navItem.classList.add('active');
            
            if (viewName !== 'chat') {
                loadViewData(viewName);
            }
        }

        // --- MOBILE: PULL TO REFRESH ---
        function handlePullStart(e) {
            const mainContent = document.querySelector('.main-content');
            if (mainContent && mainContent.scrollTop === 0) {
                pullStartY = e.changedTouches[0].screenY;
                isPulling = true;
            }
        }

        function handlePullMove(e) {
            if (!isPulling) return;
            
            const deltaY = e.changedTouches[0].screenY - pullStartY;
            const pullContainer = document.querySelector('.pull-refresh-container');
            
            if (deltaY > 0 && deltaY < 150) {
                pullContainer.style.transform = `translateY(${deltaY}px)`;
            }
        }

        function handlePullEnd(e) {
            if (!isPulling) return;
            
            const deltaY = e.changedTouches[0].screenY - pullStartY;
            const pullContainer = document.querySelector('.pull-refresh-container');
            
            if (deltaY > 80) {
                // Trigger refresh
                pullContainer.classList.add('active');
                refreshCurrentView();
                
                setTimeout(() => {
                    pullContainer.classList.remove('active');
                    pullContainer.style.transform = '';
                }, 1500);
            } else {
                pullContainer.style.transform = '';
            }
            
            isPulling = false;
        }

        function refreshCurrentView() {
            const activeView = document.querySelector('.view-section.active');
            if (!activeView) return;
            
            const viewId = activeView.id.replace('view-', '');
            if (viewId !== 'chat') {
                loadViewData(viewId);
            }
            showToast('Atualizado!', 'success');
        }

        // --- MOBILE: BOTTOM SHEETS ---
        function openBottomSheet(sheetId) {
            const sheet = document.getElementById(sheetId);
            const backdrop = document.querySelector('.bottom-sheet-backdrop');
            
            if (sheet && backdrop) {
                sheet.classList.add('active');
                backdrop.classList.add('active');
            }
        }

        function closeBottomSheet(sheetId) {
            const sheet = document.getElementById(sheetId);
            const backdrop = document.querySelector('.bottom-sheet-backdrop');
            
            if (sheet && backdrop) {
                sheet.classList.remove('active');
                backdrop.classList.remove('active');
            }
        }

        // Convert existing modals to bottom sheets on mobile
        function adaptModalsToMobile() {
            const isMobile = window.innerWidth <= 768;
            if (!isMobile) return;
            
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (!modal.classList.contains('bottom-sheet')) {
                    modal.classList.add('bottom-sheet');
                    
                    // Add drag handle
                    const handle = document.createElement('div');
                    handle.className = 'bottom-sheet-handle';
                    modal.querySelector('.card').insertBefore(handle, modal.querySelector('.card').firstChild);
                }
            });
        }

        // --- HISTORY API (Browser Back Button) ---
        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.view) {
                switchViewDirect(event.state.view);
            }
        });

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            firebase.initializeApp(config.firebaseConfig);
            
            // Auth Listeners
            document.getElementById('emailLoginBtn').addEventListener('click', async () => {
                const email = document.getElementById('emailInput').value;
                const password = document.getElementById('passwordInput').value;
                try {
                    await firebase.auth().signInWithEmailAndPassword(email, password);
                } catch (e) {
                    showToast(e.message, 'error');
                }
            });

            document.getElementById('googleLoginBtn').addEventListener('click', async () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    await firebase.auth().signInWithPopup(provider);
                } catch (e) {
                    showToast(e.message, 'error');
                }
            });

            document.getElementById('signOutBtn').addEventListener('click', () => firebase.auth().signOut());

            // Chat Listeners
            document.getElementById('send-btn').addEventListener('click', handleSendMessage);
            document.getElementById('message-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') handleSendMessage();
            });
            
            document.getElementById('fileUploadBtn').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('fileInput').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        currentFileUpload = {
                            filename: file.name,
                            content_base64: ev.target.result.split(',')[1],
                            mimetype: file.type
                        };
                        document.querySelector('.file-name-display').textContent = file.name;
                        document.querySelector('.attachment-info').style.display = 'flex';
                        document.getElementById('fileUploadBtn').style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                }
            });

            document.querySelector('.attachment-clear-icon').addEventListener('click', () => {
                currentFileUpload = null;
                document.getElementById('fileInput').value = '';
                document.querySelector('.attachment-info').style.display = 'none';
                document.getElementById('fileUploadBtn').style.display = 'block';
            });

            // Auth State Observer
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    document.getElementById('authSection').classList.remove('active');
                    document.getElementById('mainAppContainer').style.display = 'flex';
                    document.getElementById('userNameDisplay').textContent = user.displayName || user.email.split('@')[0];
                    hideGlobalLoader();
                } else {
                    currentUser = null;
                    document.getElementById('authSection').classList.add('active');
                    document.getElementById('mainAppContainer').style.display = 'none';
                    hideGlobalLoader();
                }
            });

            // Initial Theme
            if (localStorage.getItem('theme') === 'light') {
                toggleTheme();
            }
        });
    </script>
</body>
</html>