<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EIXA</title>
    
    <style>
        /* Variáveis CSS (Custom Properties) */
        :root {
            /* Modo Claro */
            --bg-primary: hsl(0, 0%, 100%); /* Fundo principal, cards, sidebar */
            --bg-secondary: hsl(240, 20%, 98%); /* Fundo geral da página, inputs */
            --bg-tertiary: hsl(240, 15%, 95%); /* Elementos de destaque suave, hover */
            --bg-card: hsl(0, 0%, 100%); /* Fundo de cards */
            
            /* Acento principal: lavanda pastel suave */
            --primary-accent: hsl(255, 75%, 70%); /* Mais vibrante */
            --primary-accent-light: hsl(255, 85%, 96%); /* Para gradientes e fundos claros */
            --primary-accent-darker: hsl(255, 65%, 60%); /* Versão mais escura para hover/active */
            
            --text-primary: hsl(240, 10%, 15%); /* Texto principal */
            --text-secondary: hsl(240, 8%, 40%); /* Texto secundário, ícones */
            --text-placeholder: hsl(240, 6%, 60%); /* Placeholder de input */
            
            --border-color: hsl(240, 10%, 90%); /* Cor da borda padrão */
            
            --user-bubble-bg: var(--primary-accent-light); /* Balão de chat do usuário (lavanda muito clara) */
            --ai-bubble-bg: hsl(0, 0%, 100%); /* Balão de chat da IA (branco puro) */
            
            /* Cores de status */
            --success-green: hsl(145, 63%, 42%);
            --error-red: hsl(0, 82%, 63%);
            --warning-orange: hsl(39, 92%, 58%);
            --info-blue: hsl(210, 79%, 65%);
            
            /* Sombras e transições */
            --shadow-subtle: 0 1px 3px rgba(0,0,0,0.03); /* Sombra mais leve */
            --shadow-medium: 0 4px 12px rgba(100,100,150,0.08); /* Sombra média, mais difusa */
            --shadow-strong: 0 8px 20px rgba(100,100,150,0.12); /* Sombra forte, para elementos elevados */
            --transition-speed: 0.3s; /* Velocidade de transição padrão */
            
            /* Tipografia - Adjusted to favor Inter/Space Grotesk for body and Roboto/Poppins for headings */
            --font-heading: 'Roboto', 'Poppins', sans-serif; /* Roboto for headings */
            --font-body: 'Inter', 'Space Grotesk', sans-serif; /* Inter, Space Grotesk for body text - modern and cozy */
            --font-size-base: 16px;
            
            /* Espaçamento e Bordas - Increased for better UX */
            --spacing-xs: 4px; 
            --spacing-sm: 8px; 
            --spacing-md: 16px; 
            --spacing-lg: 24px; 
            --spacing-xl: 32px; 
            --spacing-xxl: 48px; /* New larger spacing */

            --border-radius-sm: 8px; 
            --border-radius-md: 12px; 
            --border-radius-lg: 16px; 
            --border-radius-xl: 24px;

            /* Novas cores para botões de provedores externos */
            --google-blue: #4285F4;
            --google-blue-dark: #357AE8;
            --google-text: #111; /* Para texto em botões Google em light mode */

            /* NOVAS CORES ESPECÍFICAS DA EIXA (sugeridas para paleta cintilante) */
            --eixa-lavender-accent: #D0B0FF; /* Lilás luminoso para acentos */
            --eixa-dark-purple: #2F005B; /* Roxo escuro para elementos de destaque */
            --eixa-glow-color: rgba(208,176,255,1); /* Cor base para o brilho cintilante */

            /* NOVAS CORES PARA EVENTOS DA AGENDA */
            --eixa-task-color: var(--primary-accent); /* Tarefas criadas na EIXA */
            --eixa-task-bg: var(--primary-accent-light); 
            --google-calendar-event-color: var(--google-blue); /* Eventos do Google Calendar */
            --google-calendar-event-bg: color-mix(in srgb, var(--google-blue) 10%, transparent);
            --routine-task-color: var(--success-green); /* Tarefas de rotina */
            --routine-task-bg: color-mix(in srgb, var(--success-green) 10%, transparent);
        }

        /* Dark Mode */
        body.dark-mode {
            --bg-primary: hsl(240, 8%, 12%);
            --bg-secondary: hsl(240, 8%, 8%);
            --bg-tertiary: hsl(240, 8%, 18%);
            --bg-card: hsl(240, 8%, 15%);
            
            --primary-accent: hsl(255, 60%, 75%); /* Ligeiramente mais claro para contraste */
            --primary-accent-light: hsl(255, 15%, 25%); /* Para gradientes e fundos claros */
            --primary-accent-darker: hsl(255, 50%, 65%);
            
            --text-primary: hsl(240, 10%, 95%);
            --text-secondary: hsl(240, 5%, 60%); /* Mais claro para legibilidade */
            --text-placeholder: hsl(240, 5%, 45%);
            
            --border-color: hsl(240, 5%, 25%);
            
            --user-bubble-bg: var(--primary-accent-light); /* Lavanda escura sutil */
            --ai-bubble-bg: hsl(240, 8%, 18%); /* Fundo da IA mais escuro */
            
            /* Dark Mode para botões externos */
            --google-blue: #4285F4; /* Mantém a cor base do Google */
            --google-blue-dark: #357AE8;
            --google-text: hsl(240, 10%, 95%); /* Texto mais claro para dark mode */

            /* NOVAS CORES ESPECÍFICAS DA EIXA (sugeridas) - Manter consistentes */
            --eixa-lavender-accent: #D0B0FF;
            --eixa-dark-purple: #2F005B;
            --eixa-glow-color: rgba(208,176,255,1); /* Cor base para o brilho cintilante */

            /* NOVAS CORES PARA EVENTOS DA AGENDA (Dark Mode) */
            --eixa-task-color: var(--primary-accent);
            --eixa-task-bg: color-mix(in srgb, var(--primary-accent) 15%, transparent);
            --google-calendar-event-color: var(--google-blue);
            --google-calendar-event-bg: color-mix(in srgb, var(--google-blue) 15%, transparent);
            --routine-task-color: var(--success-green);
            --routine-task-bg: color-mix(in srgb, var(--success-green) 15%, transparent);
        }

        /* 2. BASE E LAYOUT GERAL ======================================== */
        * { 
            box-sizing: border-box; 
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease, 
                        border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease,
                        transform var(--transition-speed) ease, opacity var(--transition-speed) ease,
                        text-shadow var(--transition-speed) ease, filter var(--transition-speed) ease,
                        width var(--transition-speed) ease, height var(--transition-speed) ease, top var(--transition-speed) ease, left var(--transition-speed) ease; /* Adicionado 'height', 'top', 'left' para transição de blocos da agenda */
        }

        html, body {
            height: 100%; 
            min-height: 100vh;
            margin: 0;
            font-family: var(--font-body);
            font-size: var(--font-size-base);
            line-height: 1.7;
            color: var(--text-primary);
            background-color: var(--bg-secondary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-y: auto;
            overflow-x: hidden;
            background-image: linear-gradient(to bottom, 
                color-mix(in srgb, var(--primary-accent-light) 10%, transparent) 0%, 
                transparent 50%, 
                color-mix(in srgb, var(--primary-accent-light) 5%, transparent) 100%
            );
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        body.dark-mode {
            background-image: linear-gradient(to bottom, 
                color-mix(in srgb, var(--primary-accent-light) 5%, transparent) 0%, 
                transparent 50%, 
                color-mix(in srgb, var(--primary-accent-light) 2%, transparent) 100%
            );
        }

        .global-loader {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--bg-primary);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .global-loader.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        @keyframes fillPulse {
            0% { filter: brightness(0.5) saturate(0.8) drop-shadow(0 0 5px var(--eixa-glow-color)); transform: scale(0.95); }
            50% { filter: brightness(1.5) saturate(1.2) drop-shadow(0 0 15px var(--eixa-glow-color)); transform: scale(1.05); }
            100% { filter: brightness(0.5) saturate(0.8) drop-shadow(0 0 5px var(--eixa-glow-color)); transform: scale(0.95); }
        }

        #loader-eixa {
            width: 64px;
            height: 64px;
            animation: fillPulse 2.5s ease-in-out infinite;
        }

        .app-container {
            display: flex;
            flex-direction: row;
            width: 100vw; height: 100vh;
            max-width: 1800px;
            margin: 0 auto;
            background-color: var(--bg-primary);
            overflow: hidden;
            transition: background-color var(--transition-speed) ease;
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-strong);
        }

        .hidden-input { display: none; }

        .material-icons {
            font-size: 24px;
            color: var(--text-secondary);
            vertical-align: middle;
            transition: color var(--transition-speed) ease;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        .header-eixa {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-xs);
            margin-top: var(--spacing-xl);
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
            padding: 0;
        }
        .header-eixa img {
            height: 40px;
            width: 40px;
            object-fit: contain;
            filter: drop-shadow(0 0 5px var(--eixa-glow-color));
            transition: filter 0.3s ease;
        }
        .header-eixa span {
            font-family: var(--font-body);
            font-size: 20px; 
            font-weight: 600;
            color: var(--eixa-lavender-accent);
            letter-spacing: -0.05em;
            transition: opacity 0.3s ease;
        }

        .app-subtitle {
            font-family: var(--font-body);
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-top: var(--spacing-xs);
        }

        .auth-section {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: var(--spacing-lg);
            background-color: #0A0A0A;
            background-image: none;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        .auth-section.active {
            opacity: 1;
            visibility: visible;
        }
        .auth-card {
            background-color: var(--bg-primary);
            padding: var(--spacing-xxl) var(--spacing-xl);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-strong);
            border: 1px solid var(--border-color);
            max-width: 450px;
            width: 100%;
            text-align: center;
            animation: fadeIn 0.5s ease-in-out;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }
        .auth-header {
            margin-bottom: var(--spacing-md);
        }
        .auth-card-title {
            font-family: var(--font-heading);
            font-size: 1.8em;
            color: var(--text-primary);
            margin: var(--spacing-md) 0 var(--spacing-sm) 0;
            font-weight: 700;
            text-shadow: 0 0 5px color-mix(in srgb, var(--eixa-lavender-accent) 30%, transparent);
        }
        .auth-card-subtitle {
            font-family: var(--font-body);
            font-size: 1em;
            color: hsl(240, 8%, 40%);
            font-weight: 400;
            margin-bottom: var(--spacing-lg);
            line-height: 1.5;
        }
        .auth-welcome { display: none; }

        .auth-section .header-eixa {
            padding: 0;
            justify-content: center;
            margin-bottom: var(--spacing-lg);
            gap: var(--spacing-md);
        }

        .auth-section .header-eixa img {
            height: 48px;
            filter: drop-shadow(0 0 8px var(--eixa-glow-color));
            animation: logoPulse 3s ease-in-out infinite; 
        }
        @keyframes logoPulse {
            0%, 100% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(1.05); opacity: 1; }
        }

        .auth-section .header-eixa span {
            font-size: 28px;
        }

        #manualAuthContainer {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            width: 100%;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: var(--spacing-xs);
            width: 100%;
        }

        .input-group input[type="email"],
        .input-group input[type="password"] {
            width: 100%;
            padding: var(--spacing-md);
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius-md);
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 1em;
        }
        .input-group input::placeholder {
            color: var(--text-placeholder);
        }

        .input-group input[type="email"]:focus,
        .input-group input[type="password"]:focus {
            outline: none;
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 4px color-mix(in srgb, var(--primary-accent) 25%, transparent), inset 0 1px 3px rgba(0,0,0,0.05);
        }

        .auth-buttons-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
        }
        .auth-button {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-lg);
            font-family: var(--font-body);
            font-weight: 600;
            font-size: 1rem;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            box-shadow: var(--shadow-subtle);
        }

        .auth-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .auth-button.button-primary { 
            background: linear-gradient(45deg, var(--primary-accent), var(--primary-accent-darker));
            color: white;
            border: none;
            box-shadow: var(--shadow-medium);
        }
        .auth-button.button-primary:hover:not(:disabled) {
            background: linear-gradient(45deg, var(--primary-accent-darker), var(--primary-accent));
            box-shadow: var(--shadow-strong);
            transform: translateY(-2px);
        }

        .auth-button.button-secondary { 
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        .auth-button.button-secondary:hover:not(:disabled) {
            background-color: var(--bg-tertiary);
            border-color: var(--primary-accent);
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }

        .auth-button.google-button {
            background-color: white;
            color: var(--google-text); /* Use new variable for text color */
            padding: 12px 16px;
            border: 1px solid var(--border-color);
        }
        /* Dark mode specific for google button */
        body.dark-mode .auth-button.google-button {
            background-color: hsl(240, 8%, 25%); /* More grey in dark mode */
            border-color: var(--border-color);
            color: var(--google-text);
        }

        .auth-button.google-button:hover:not(:disabled) {
            background-color: var(--bg-tertiary);
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }

        .auth-button.google-button .google-icon {
            width: 20px;
            height: 20px;
            vertical-align: middle;
        }

        .divider {
            display: flex;
            align-items: center;
            text-align: center;
            font-size: 0.9em;
            margin: var(--spacing-md) 0;
            color: var(--text-secondary);
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid var(--border-color);
        }

        .divider:not(:empty)::before {
            margin-right: var(--spacing-md);
        }

        .divider:not(:empty)::after {
            margin-left: var(--spacing-md);
        }

        .error-message {
            background-color: color-mix(in srgb, var(--error-red) 10%, transparent);
            color: var(--error-red);
            border: 1px solid var(--error-red);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-sm);
            font-size: 0.9em;
            text-align: left;
            margin-bottom: var(--spacing-md);
            line-height: 1.4;
            font-weight: 500;
        }

        /* 3. SIDEBAR (Navigation) ======================================== */
        .sidebar-menu {
            background-color: var(--bg-primary);
            display: flex; flex-direction: column; flex-shrink: 0;
            position: relative;
            overflow-y: auto;
        }
        .sidebar-header { 
            display: none;
            position: relative;
            padding-top: 0;
        } 
        .sidebar-top-section {
            display: none;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            width: 100%;
            margin-bottom: var(--spacing-md);
        }

        .sidebar-toggle-btn { 
            position: absolute; 
            top: var(--spacing-sm);
            right: var(--spacing-sm);
            margin-left: 0;
            transform: none;
            padding: var(--spacing-sm);
            border-radius: 50%;
            flex-shrink: 0;
        }

        .tabs-container {
            display: flex; 
            flex-direction: row;
            justify-content: space-around;
            padding: var(--spacing-sm) 0;
            overflow-y: auto;
        }
        .tab-button {
            display: flex; flex-direction: column; align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm);
            border: none;
            background-color: transparent;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: var(--border-radius-md);
            position: relative;
        }
        .tab-button:hover {
            color: var(--text-primary);
            background-color: var(--bg-tertiary);
        }
        .tab-button:hover .material-icons {
            color: var(--primary-accent);
        }

        .tab-button.active {
            color: var(--eixa-lavender-accent);
            font-weight: 600;
            background: linear-gradient(90deg, color-mix(in srgb, var(--eixa-lavender-accent) 5%, transparent) 0%, transparent 100%);
            box-shadow: 0 0 5px color-mix(in srgb, var(--eixa-lavender-accent) 20%, transparent);
        }
        .tab-button.active .material-icons {
            color: var(--eixa-lavender-accent);
        }
        .sidebar-footer { display: none; }

        .current-datetime-display {
            font-family: var(--font-body);
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-top: var(--spacing-sm);
            text-align: center;
        }

        body.dark-mode .current-datetime-display {
            color: var(--text-secondary);
        }

        .sidebar-menu.collapsed .current-datetime-display {
            display: none;
        }

        /* 4. MAIN CONTENT AREA ================================== */
        .main-content-area {
            display: flex; flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
            position: relative;
            order: 1;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        @keyframes slideInFromLeft { 
            from { opacity: 0; transform: translateX(-20px); } 
            to { opacity: 1; transform: translateX(0); } 
        }
        
        @keyframes slideInFromRight { 
            from { opacity: 0; transform: translateX(20px); } 
            to { opacity: 1; transform: translateX(0); } 
        }
        
        @keyframes scaleIn { 
            from { opacity: 0; transform: scale(0.95); } 
            to { opacity: 1; transform: scale(1); } 
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .view-content {
            display: none; flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
            opacity: 0;
            transform: translateY(10px);
        }
        .view-content.active {
            display: flex;
            opacity: 1;
            transform: translateY(0);
            animation: fadeIn 0.3s ease-out forwards; /* Adicionado para a transição de view */
        }

        .view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            background-color: var(--bg-primary);
        }
        .view-content-title {
            font-family: var(--font-heading);
            font-size: 1.8em;
            color: var(--text-primary);
            margin: 0;
            text-shadow: 0 0 5px color-mix(in srgb, var(--eixa-glow-color) 40%, transparent), 
                                0 0 10px color-mix(in srgb, var(--eixa-glow-color) 20%, transparent);
            animation: textGlowPulse 3s ease-in-out infinite alternate;
        }

        @keyframes textGlowPulse {
            0% { text-shadow: 0 0 4px color-mix(in srgb, var(--eixa-glow-color) 30%, transparent), 0 0 8px color-mix(in srgb, var(--eixa-glow-color) 15%, transparent); }
            100% { text-shadow: 0 0 6px color-mix(in srgb, var(--eixa-glow-color) 60%, transparent), 0 0 12px color-mix(in srgb, var(--eixa-glow-color) 30%, transparent); }
        }

        .content-display-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: var(--spacing-xl);
            background-color: var(--bg-secondary);
        }
        .view-intro {
            padding: var(--spacing-md) var(--spacing-xl);
            color: var(--text-secondary);
            text-align: center;
            font-size: 0.95em;
            margin: 0;
            flex-shrink: 0;
            background-color: var(--bg-secondary);
        }

        /* 5. CHAT VIEW ================================================== */
        .chat-display {
            flex-grow: 1; overflow-y: auto;
            padding: var(--spacing-xl);
            display: flex; flex-direction: column;
            gap: var(--spacing-md);
        }
        .message {
            padding: var(--spacing-md);
            border-radius: var(--border-radius-lg);
            max-width: 90%;
            word-wrap: break-word;
            box-shadow: var(--shadow-subtle);
            display: flex;
            gap: var(--spacing-sm);
            align-items: flex-start;
        }
        .message-content { line-height: 1.6; }
        .message ul { padding-left: var(--spacing-lg); margin: var(--spacing-sm) 0; }
        .message strong { color: var(--text-primary); font-weight: 600; }
        .message h3 { font-family: var(--font-heading); margin: var(--spacing-md) 0 var(--spacing-sm) 0; font-size: 1.2em; }
        .message h4 { font-family: var(--font-heading); margin: var(--spacing-md) 0 var(--spacing-sm) 0; font-size: 1.1em; }

        .user-message {
            align-self: flex-end;
            background-color: var(--user-bubble-bg);
            color: var(--primary-accent-darker);
            border-bottom-right-radius: var(--spacing-md);
        }
        .ai-message {
            align-self: flex-start;
            background-color: var(--ai-bubble-bg);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: var(--spacing-md);
        }
        
        .ai-avatar {
            background-color: var(--bg-tertiary);
            border-radius: 50%;
            width: 36px; height: 36px;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
        }
        .ai-avatar img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            animation: fillPulse 2.5s ease-in-out infinite;
        }


        .chat-input-area {
            padding: var(--spacing-lg);
            background-color: var(--bg-primary);
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: var(--spacing-sm);
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius-xl);
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-subtle);
        }
        .input-wrapper:focus-within {
            outline: none;
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 4px color-mix(in srgb, var(--primary-accent) 25%, transparent), inset 0 1px 3px rgba(0,0,0,0.05);
        }
        textarea#messageInput {
            flex-grow: 1; 
            background: transparent; 
            border: none;
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 1em; 
            resize: none; 
            outline: none;
            max-height: 150px; 
            overflow-y: auto;
            padding: var(--spacing-xs) 0;
            line-height: 1.5;
        }
        textarea#messageInput::placeholder { 
            color: var(--text-placeholder); 
            line-height: normal;
            vertical-align: middle;
        }

        .attachment-info {
            display: flex; align-items: center; gap: var(--spacing-sm);
            background-color: var(--bg-tertiary);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            font-size: 0.85em;
            animation: fadeIn 0.3s;
        }
        .attachment-clear-icon { cursor: pointer; color: var(--text-secondary); }
        .attachment-clear-icon .material-icons { color: var(--text-secondary); }
        .attachment-clear-icon:hover .material-icons { color: var(--primary-accent); }


        .suggested-sections {
            background-color: var(--bg-tertiary);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-subtle);
        }
        .suggested-sections h3 {
            font-family: var(--font-heading);
            font-size: 1.1em;
            color: var(--text-primary);
            margin: 0 0 var(--spacing-sm) 0;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        .suggested-sections h3 .material-icons {
            color: var(--primary-accent);
        }
        .suggested-sections ul {
            list-style: none;
            padding-left: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }
        .suggested-sections ul li {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        /* 6. CARDS (Projetos, Emotional Memories) ======================== */
        .cards-grid {
            display: grid; gap: var(--spacing-lg);
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }
        .project-card, .diagnostic-card, .emotional-memory-card, .routine-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-xl);
            box-shadow: var(--shadow-medium);
            display: flex; flex-direction: column;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: scaleIn 0.4s ease-out;
        }
        .project-card:hover, .routine-card:hover, .diagnostic-card:hover, .emotional-memory-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-strong);
        }
        .project-card h4, .diagnostic-card h4, .emotional-memory-card h4, .routine-card h4 {
            font-family: var(--font-heading);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.25em;
            margin: 0 0 var(--spacing-md) 0;
            display: flex; align-items: center; gap: var(--spacing-sm);
        }
        .project-card h4 .material-icons, 
        .diagnostic-card h4 .material-icons, 
        .emotional-memory-card h4 .material-icons,
        .routine-card h4 .material-icons {
            color: var(--primary-accent);
        }
        .project-card p, .diagnostic-card p, .emotional-memory-card p, .routine-card p {
            font-size: 1em;
            color: var(--text-secondary);
            margin: 0 0 var(--spacing-md) 0;
        }
        .project-microtasks-list, .diagnostic-category ul, .long-term-profile-display ul {
            list-style: none; padding-left: 0;
            margin: 0 0 var(--spacing-md) 0;
            display: flex; flex-direction: column; gap: var(--spacing-xs);
        }
        .project-microtasks-list li::before {
            content: '○'; color: var(--primary-accent);
            position: absolute; left: 0;
        }
        .project-microtasks-list li { 
            padding-left: var(--spacing-md); 
            position: relative; 
            cursor: pointer;
            transition: all 0.2s ease;
            padding: var(--spacing-xs) 0 var(--spacing-xs) var(--spacing-md);
            border-radius: var(--border-radius-sm);
        }
        .project-microtasks-list li:hover {
            background-color: var(--bg-hover);
            padding-left: calc(var(--spacing-md) + 4px);
        }
        .project-microtasks-list li.completed { 
            text-decoration: line-through; 
            opacity: 0.6; 
        }
        .project-microtasks-list li.completed::before { content: '●'; }

        .card-actions { display: flex; justify-content: flex-end; margin-top: auto; padding-top: var(--spacing-md); }

        /* 7. AGENDA (NOVA ESTRUTURA DE TIMELINE) =========================== */
        /* Esta agora será a única view de tarefas/eventos */
        #agendaDisplay { /* ID da div de exibição */
            position: relative; 
            height: calc(100% - var(--spacing-xxl)); 
            overflow-y: auto; 
            padding-right: var(--spacing-lg); 
            padding-top: var(--spacing-md);
            padding-bottom: var(--spacing-md);
        }
        .agenda-timeline-grid {
            display: grid;
            grid-template-columns: 60px 1fr; 
            grid-auto-rows: 60px; 
            position: relative;
            height: 1440px; 
            border-left: 1px solid var(--border-color); 
            padding-left: var(--spacing-md);
        }
        .time-label {
            grid-column: 1;
            position: sticky;
            left: 0;
            top: 0; 
            font-size: 0.8em;
            color: var(--text-secondary);
            text-align: right;
            padding-right: var(--spacing-sm);
            margin-top: -10px; 
            pointer-events: none; 
            z-index: 5; 
        }
        .timeline-hour-line {
            grid-column: 2;
            border-bottom: 1px dashed var(--border-color); 
            position: relative;
            margin-top: -1px; 
            pointer-events: none;
        }
        .timeline-current-time-indicator {
            position: absolute;
            left: 0; 
            width: 100%; 
            height: 2px;
            background-color: var(--error-red); 
            z-index: 10;
            transition: top 60s linear; 
            pointer-events: none;
        }
        .timeline-current-time-indicator::after {
            content: '';
            position: absolute;
            right: 0;
            top: -4px;
            width: 10px;
            height: 10px;
            background-color: var(--error-red);
            border-radius: 50%;
            border: 2px solid var(--bg-primary);
        }

        /* Blocos de Tarefas/Eventos (agora posicionados absolutamente) */
        .agenda-event-block {
            position: absolute;
            left: 60px; 
            width: calc(100% - 60px); 
            background-color: var(--eixa-task-bg);
            border-left: 4px solid var(--eixa-task-color);
            border-radius: var(--border-radius-sm);
            padding: var(--spacing-xs) var(--spacing-sm);
            color: var(--text-primary);
            font-size: 0.9em;
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            gap: 2px;
            justify-content: center;
            box-shadow: var(--shadow-subtle);
            cursor: pointer;
            z-index: 5; 
        }
        .agenda-event-block:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
            z-index: 11; 
        }
        .agenda-event-block.task-completed {
            opacity: 0.7;
            border-left-color: var(--success-green);
            text-decoration: line-through;
        }

        /* Cores e Ícones por Origem */
        .agenda-event-block.origin-google_calendar {
            background-color: var(--google-calendar-event-bg);
            border-left-color: var(--google-calendar-event-color);
        }
        .agenda-event-block.origin-routine { 
            background-color: var(--routine-task-bg);
            border-left-color: var(--routine-task-color);
        }
        .agenda-event-block .event-icons {
            position: absolute;
            top: var(--spacing-xs);
            right: var(--spacing-xs);
            display: flex;
            gap: 4px;
            align-items: center;
            flex-wrap: wrap;
        }
        .agenda-event-block .event-icons .material-icons {
            font-size: 16px; 
            color: var(--text-secondary);
        }
        
        /* Badges de origem das tarefas */
        .event-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: 700;
            white-space: nowrap;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .event-badge .material-icons {
            font-size: 12px !important;
        }
        
        .badge-eixa {
            background: linear-gradient(135deg, var(--eixa-task-bg), color-mix(in srgb, var(--eixa-task-bg) 80%, white));
            color: var(--eixa-task-color);
            border: 1px solid var(--eixa-task-color);
            box-shadow: 0 2px 4px rgba(208,176,255,0.2);
        }
        
        .badge-google {
            background: linear-gradient(135deg, var(--google-calendar-event-bg), color-mix(in srgb, var(--google-calendar-event-bg) 80%, white));
            color: var(--google-calendar-event-color);
            border: 1px solid var(--google-calendar-event-color);
            box-shadow: 0 2px 4px rgba(66,133,244,0.2);
        }
        
        .badge-routine {
            background: linear-gradient(135deg, var(--routine-task-bg), color-mix(in srgb, var(--routine-task-bg) 80%, white));
            color: var(--routine-task-color);
            border: 1px solid var(--routine-task-color);
            box-shadow: 0 2px 4px rgba(52,168,83,0.2);
        }
        
        .completion-icon {
            color: var(--success-green) !important;
            font-size: 16px !important;
            filter: drop-shadow(0 0 2px var(--success-green));
        }

        /* Diagnostic Cards */
        .diagnostic-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-medium);
            transition: all 0.3s ease;
        }
        
        .diagnostic-card:hover {
            box-shadow: var(--shadow-large);
            transform: translateY(-2px);
        }
        
        .diagnostic-card h3 {
            color: var(--eixa-dark-purple);
            font-size: 1.4em;
            margin-bottom: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .diagnostic-date {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: var(--spacing-md);
            font-style: italic;
        }
        
        .diagnostic-content {
            color: var(--text-primary);
            line-height: 1.6;
            margin-bottom: var(--spacing-md);
        }
        
        .diagnostic-insights {
            background: linear-gradient(135deg, rgba(147, 51, 234, 0.05), rgba(147, 51, 234, 0.1));
            border-left: 3px solid var(--eixa-purple);
            padding: var(--spacing-md);
            margin-top: var(--spacing-md);
            border-radius: var(--border-radius-md);
        }
        
        .diagnostic-metrics {
            background: var(--bg-secondary);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-md);
            margin-top: var(--spacing-md);
            font-size: 0.95em;
        }
        
        .diagnostic-metrics strong {
            color: var(--eixa-dark-purple);
        }

        /* SEÇÃO PARA EXIBIR TEMPLATES DE ROTINA, POSSIVELMENTE NO PERFIL OU EM OUTRA VIEW MENOS PROMINENTE */
        /* Manter estilos de .routine-card pois ainda podem ser usados em outros lugares */
        .routine-card {
            /* Herda de .cards-grid e .project-card */
            padding: var(--spacing-lg);
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-medium);
        }
        .routine-card h4 {
            /* Herda de .project-card h4 */
            font-size: 1.3em;
            color: var(--eixa-dark-purple);
        }
        .routine-card .routine-description {
            font-size: 0.95em;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
        }
        .routine-card .routine-days {
            font-size: 0.85em;
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: var(--spacing-md);
        }
        .routine-card .routine-schedule-list {
            list-style: none;
            padding-left: 0;
            margin-bottom: var(--spacing-md);
            border-top: 1px dashed var(--border-color);
            padding-top: var(--spacing-md);
        }
        .routine-card .routine-schedule-list li {
            font-size: 0.9em;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
        }
        .routine-card .routine-schedule-list li strong {
            color: var(--eixa-lavender-accent);
            font-weight: 700;
        }
        .routine-card .routine-schedule-list li .material-icons {
            font-size: 18px;
            color: var(--eixa-lavender-accent);
        }


        /* 8. DIAGNOSTICS (now Emotional Memories) ================ */
        .diagnostic-intro { padding: 0 var(--spacing-lg); color: var(--text-secondary); text-align: center; }
        .diagnostic-card h4 .material-icons { color: var(--primary-accent); }
        .diagnostic-category {
            margin-bottom: var(--spacing-lg);
            background-color: var(--bg-secondary);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-md);
            border: 1px solid var(--border-color);
        }
        .diagnostic-category ul li {
            padding-left: var(--spacing-md);
            position: relative;
            color: var(--text-secondary);
        }
        .diagnostic-category ul li::before {
            content: "chevron_right";
            font-family: 'Material Icons';
            font-weight: normal; font-style: normal;
            position: absolute; left: -4px; top: 1px;
            color: var(--primary-accent);
            font-size: 1.2em;
        }
        .diagnostic-timestamp { font-weight: 500; font-size: 0.9em; color: var(--text-secondary); }


        /* 8.1. NEW STYLES: EMOTIONAL MEMORIES */
        .emotional-memory-card {
            padding: var(--spacing-lg);
        }
        .emotional-memory-card .memory-timestamp {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
            text-align: right;
        }
        .emotional-memory-card .memory-content {
            font-size: 1em;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
            line-height: 1.5;
        }
        .emotional-memory-card .memory-tags-list {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-xs);
            margin-top: var(--spacing-sm);
            justify-content: flex-end;
        }
        .emotional-memory-card .memory-tag {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 0.8em;
            padding: 4px var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
            text-transform: capitalize;
        }
        .emotional-memory-card .memory-tag.no-tags {
            opacity: 0.7;
        }

        /* 8.2. NEW STYLES: LONG-TERM MEMORY (PROFILE) E GOOGLE CALENDAR */
        .long-term-profile-display {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-xl);
            box-shadow: var(--shadow-medium);
            margin-bottom: var(--spacing-md);
        }
        .long-term-profile-display h3 {
            font-family: var(--font-heading);
            font-weight: 700;
            font-size: 1.5em;
            color: var(--primary-accent);
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            border-bottom: 2px solid var(--primary-accent);
            padding-bottom: var(--spacing-sm);
        }
        .long-term-profile-display h3:first-child { margin-top: 0; }

        .long-term-profile-display h4 {
            font-family: var(--font-heading);
            font-weight: 600;
            font-size: 1.2em;
            color: var(--text-primary);
            margin-top: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
        }
        .long-term-profile-display p {
            font-size: 1em;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
        }
        .long-term-profile-display p strong {
            color: var(--text-secondary);
            font-weight: 500;
        }
        .long-term-profile-display ul {
            list-style-type: none;
            padding-left: 0;
            margin-bottom: var(--spacing-md);
        }
        .long-term-profile-display ul li {
            font-size: 0.95em;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
            padding-left: var(--spacing-sm);
            position: relative;
        }
        .long-term-profile-display ul li::before {
            content: '•';
            color: var(--primary-accent);
            position: absolute;
            left: 0;
            top: 0;
        }
        .long-term-profile-display .profile-section {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        .long-term-profile-display .profile-section h4 {
            margin-top: 0;
            font-size: 1.1em;
            color: var(--primary-accent-darker);
        }

        /* Google Calendar Integration Button Style */
        .connect-google-button {
            background-color: var(--google-blue);
            color: white; /* Always white text for Google blue */
            padding: var(--spacing-md) var(--spacing-lg);
            font-family: var(--font-body);
            font-weight: 600;
            font-size: 1rem;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            box-shadow: var(--shadow-subtle);
            margin-top: var(--spacing-md); /* Space from other elements */
            width: fit-content; /* Only take content width */
        }
        .connect-google-button:hover {
            background-color: var(--google-blue-dark);
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }
        .connect-google-button .material-icons {
            color: white; /* Icon also white */
        }
        .google-calendar-status-text {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-top: var(--spacing-sm);
        }


        /* 9. COMPONENTS (Buttons, Modals, Toasts, etc.) ================ */
        .icon-button {
            background: none; border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: var(--spacing-sm);
            border-radius: 50%;
            display: inline-flex; align-items: center; justify-content: center;
        }
        .icon-button:hover { background-color: var(--bg-tertiary); color: var(--primary-accent); }
        .icon-button .material-icons {
            color: var(--text-secondary);
            font-size: 24px;
        }
        .icon-button:hover .material-icons { color: var(--primary-accent); }

        .add-action-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, var(--eixa-lavender-accent), var(--primary-accent-darker));
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(208,176,255,0.5), 0 0 16px rgba(208,176,255,0.3); 
            transition: all 0.3s ease-in-out;
            flex-shrink: 0;
        }

        .add-action-button:hover,
        .add-action-button:focus {
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 0 15px rgba(208,176,255,0.8), 0 0 30px rgba(208,176,255,0.6); 
        }

        .add-action-button .material-icons {
            font-size: 28px;
            color: white;
            transition: inherit;
        }

        .button-primary, .button-secondary {
            display: inline-flex; align-items: center; gap: var(--spacing-sm);
            border: none;
            padding: var(--spacing-md) var(--spacing-lg);
            font-family: var(--font-body);
            font-weight: 600;
            font-size: 1rem;
            border-radius: var(--border-radius-md);
            cursor: pointer;
        }
        .button-primary { background-color: var(--primary-accent); color: white; }
        .button-primary:hover { background-color: var(--primary-accent-darker); box-shadow: var(--shadow-medium); }
        .button-primary .material-icons {
            color: white;
        }

        .button-secondary {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        .button-secondary:hover { background-color: var(--bg-tertiary); border-color: var(--primary-accent); }
        .button-secondary .material-icons {
            color: var(--text-primary);
        }
        .button-secondary:hover .material-icons { color: var(--primary-accent); }


        .modal {
            display: flex;
            position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center; justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.active { 
            opacity: 1; 
            visibility: visible;
        }
        .modal-content {
            background: var(--bg-primary);
            padding: var(--spacing-xxl);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-strong);
            width: 90%; max-width: 550px;
            position: relative;
            display: flex; flex-direction: column; gap: var(--spacing-md);
            transform: translateY(20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-content h3 { font-family: var(--font-heading); margin: 0 0 var(--spacing-sm) 0; }
        .modal-content .close-button { position: absolute; top: var(--spacing-md); right: var(--spacing-md); }
        .modal-content label { font-weight: 600; font-size: 0.95em; color: var(--text-secondary); }
        .modal-content input[type="text"], .modal-content input[type="date"], .modal-content input[type="time"], .modal-content input[type="number"], .modal-content textarea, .modal-content select {
            width: 100%; padding: var(--spacing-md);
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius-md);
            color: var(--text-primary);
            font-family: var(--font-body); font-size: 1em;
        }
        .modal-content input:focus, .modal-content textarea:focus, .modal-content select:focus {
            outline: none; border-color: var(--primary-accent);
            box-shadow: 0 0 0 4px color-mix(in srgb, var(--primary-accent) 25%, transparent);
        }
        .modal-row { display: flex; gap: var(--spacing-md); }
        .modal-field { flex: 1; display: flex; flex-direction: column; gap: var(--spacing-xs); }
        .modal-microtask-item { display: flex; align-items: center; gap: var(--spacing-sm); }
        .modal-microtask-item input[type="text"] { flex: 1;}
        .modal-microtask-item input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--primary-accent);}
        .modal-microtask-item .remove-microtask-button .material-icons {
            color: var(--text-secondary);
        }
        .modal-microtask-item .remove-microtask-button:hover .material-icons { color: var(--error-red); }

        /* Estilo para o campo de input de texto no modal de confirmação */
        .modal-input-text {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius-sm);
            margin-top: var(--spacing-sm);
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 1em;
        }
        .modal-input-text:focus {
            outline: none;
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 4px color-mix(in srgb, var(--primary-accent) 25%, transparent);
        }


        .loading-indicator {
            display: none; color: var(--primary-accent); font-size: 0.9em;
            align-items: center; gap: var(--spacing-sm);
            padding: var(--spacing-sm) 0;
            justify-content: center;
        }
        .loading-indicator.active { display: flex; }

        .toast-container { 
            position: fixed; top: 20px; right: 20px; z-index: 9999; 
            display: flex; flex-direction: column; gap: var(--spacing-sm); 
            max-width: 90%;
        }
        /* Skeleton Loaders */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        .skeleton {
            background: linear-gradient(90deg, 
                var(--bg-tertiary) 0%, 
                var(--bg-secondary) 50%, 
                var(--bg-tertiary) 100%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
            border-radius: var(--border-radius-md);
        }
        
        .skeleton-text {
            height: 16px;
            margin-bottom: var(--spacing-sm);
        }
        
        .skeleton-card {
            height: 200px;
            margin-bottom: var(--spacing-lg);
        }
        
        /* Smooth Scroll */
        html {
            scroll-behavior: smooth;
        }
        
        /* Better scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 5px;
            transition: background 0.3s ease;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        .toast {
            padding: var(--spacing-md);
            border-radius: var(--border-radius-sm);
            color: white; font-weight: 500;
            box-shadow: var(--shadow-strong);
            transform: translateX(120%);
            opacity: 0;
            transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out;
        }
        .toast.show { transform: translateX(0); opacity: 1; }
        .toast.toast-info { background-color: var(--info-blue); }
        .toast.toast-success { background-color: var(--success-green); }
        .toast.toast-warning { background-color: var(--warning-orange); }
        .toast.toast-error { background-color: var(--error-red); }

        :focus-visible {
            outline: 2px solid var(--primary-accent);
            outline-offset: 2px;
        }

        .eixa-icon-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: var(--eixa-dark-purple);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 10px rgba(208,176,255,0.6), 0 0 20px rgba(208,176,255,0.4);
            z-index: 999;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .eixa-icon-fab:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(208,176,255,0.8), 0 0 30px rgba(208,176,255,0.6);
        }
        .eixa-icon-fab img {
            width: 32px;
            height: 32px;
            filter: drop-shadow(0 0 5px var(--eixa-glow-color));
            transition: filter 0.3s ease;
        }

        .confirmation-message {
            background-color: var(--info-blue);
            color: white;
            padding: var(--spacing-md);
            border-radius: var(--border-radius-lg);
            margin-bottom: var(--spacing-md);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            box-shadow: var(--shadow-medium);
        }
        .confirmation-actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-sm);
        }
        .confirmation-actions button {
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-md);
            cursor: pointer;
            font-weight: 600;
        }
        .confirmation-actions .confirm-yes {
            background-color: var(--success-green);
            color: white;
            border: none;
        }
        .confirmation-actions .confirm-no {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        /* Style for newly added button in confirmation modal */
        .confirmation-actions .confirm-secondary {
            background-color: var(--info-blue); /* or some other distinguishing color */
            color: white;
            border: none;
        }


        /* 10. RESPONSIVENESS (Desktop) ================================== */
        @media (min-width: 768px) {
            .app-container { 
                flex-direction: row; 
            }
            .sidebar-menu {
                order: 1;
                width: 256px;
                height: 100%;
                border-top: none;
                border-right: 1px solid var(--border-color);
                border-radius: var(--border-radius-xl) 0 0 var(--border-radius-xl);
                padding-bottom: 0;
            }
            .sidebar-menu.collapsed { 
                width: 80px;
            }
            .sidebar-menu.collapsed .app-subtitle,
            .sidebar-menu.collapsed .tab-text,
            .sidebar-menu.collapsed #welcomeMessage,
            .sidebar-menu.collapsed #userName { display: none; } 
            
            .sidebar-menu.collapsed .logo-text { display: none; }
            .sidebar-menu.collapsed .sidebar-toggle-btn .material-icons { transform: rotate(180deg); }

            .sidebar-header {
                display: flex;
                flex-direction: column;
                padding: var(--spacing-xl) var(--spacing-lg);
                padding-top: 0;
            }
            .sidebar-top-section {
                display: flex;
                align-items: center;
                justify-content: flex-start;
                width: 100%;
                margin-bottom: var(--spacing-md);
            }
            .sidebar-menu.collapsed .sidebar-top-section .logo-text {
                display: none;
            }
            .sidebar-toggle-btn { 
                margin-left: auto;
                margin-bottom: 0;
                padding: var(--spacing-sm);
            }
            
            .tabs-container {
                flex-direction: column; padding: var(--spacing-md);
                flex-grow: 1; justify-content: flex-start;
                gap: var(--spacing-sm);
            }
            .tab-button {
                flex-direction: row; justify-content: flex-start;
                gap: var(--spacing-md);
                font-size: 1rem;
                padding: var(--spacing-md);
            }
            .sidebar-menu.collapsed .tab-button {
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: var(--spacing-md) var(--spacing-sm);
            }

            .tab-button::before {
                content: '';
                position: absolute;
                left: 0;
                top: 50%;
                transform: translateY(-50%) scaleY(0);
                width: 6px;
                height: 60%;
                background: linear-gradient(to bottom, var(--eixa-lavender-accent), var(--primary-accent-darker));
                border-radius: 0 4px 4px 0;
                transition: transform 0.2s ease-in-out, box-shadow 0.2s ease;
                box-shadow: 0 0 10px color-mix(in srgb, var(--eixa-glow-color) 30%, transparent);
            }
            .tab-button.active::before {
                transform: translateY(-50%) scaleY(1);
                box-shadow: 0 0 15px color-mix(in srgb, var(--eixa-glow-color) 60%, transparent);
            }
            
            .sidebar-footer {
                display: flex; flex-direction: column;
                gap: var(--spacing-md);
                padding: var(--spacing-md);
                border-top: 1px solid var(--border-color);
                margin-top: auto;
            }
            #userDisplayArea { 
                display: flex !important; 
                align-items: center; 
                justify-content: space-between;
                gap: var(--spacing-sm);
                background-color: var(--bg-tertiary);
                padding: var(--spacing-sm) var(--spacing-md);
                border-radius: var(--border-radius-xl);
                margin-bottom: var(--spacing-md);
            }
            #signOutBtn { 
                margin-left: 0;
            }
            .app-settings-buttons { display: flex; justify-content: center; gap: var(--spacing-sm); }

            .eixa-icon-fab {
                bottom: 24px;
                right: 24px;
            }
        }
        /* Mobile styles - sidebar at the bottom (now acting as bottom nav) */
        @media (max-width: 768px) {
            /* 1. Login Mobile (Tela Travada) */
            .auth-section {
                position: absolute;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                height: auto;
                min-height: 100vh;
                align-items: flex-start;
                padding-top: var(--spacing-xxl);
                padding-bottom: var(--spacing-xxl);
            }

            .auth-card {
                margin-top: auto;
                margin-bottom: auto;
            }

            body.auth-active {
                overflow-y: auto;
                overflow-x: hidden;
            }

            /* 2. Chat Mobile */
            .main-content-area {
                flex-grow: 1;
                overflow-y: auto;
                padding-bottom: 90px;
                position: relative;
            }

            .chat-display {
                flex-grow: 1;
                overflow-y: auto;
                padding-bottom: var(--spacing-md);
            }

            .chat-input-area {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                z-index: 10;
                padding: var(--spacing-md);
                padding-bottom: calc(var(--spacing-md) + 60px);
                box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
                display: flex;
                flex-direction: column;
                gap: var(--spacing-sm);
            }
            
            .chat-input-area #inputWrapper {
                padding: var(--spacing-sm);
                border-radius: var(--border-radius-xl);
            }

            .chat-input-area textarea#messageInput {
                padding: var(--spacing-xs) 0;
            }

            #chatDisplay {
                padding-bottom: calc(var(--spacing-xl) + 120px);
            }

            #agendaDisplay, /* Este é o display da nova aba Agenda (antiga Rotinas) */
            #projetosDisplay,
            #emotionalMemoriesDisplay,
            #longTermMemoryDisplay,
            #rotinasTemplatesViewContent { /* NOVO: Para a nova view de templates de rotina */
                min-height: calc(100vh - 120px - 60px);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: calc(var(--spacing-xxl) + 60px);
            }

            /* 3. FAB (Floating Action Button da IA) */
            .eixa-icon-fab {
                display: none !important;
            }

            /* 5. Bottom Navigation (Menu Inferior apenas no Mobile) */
            .app-container {
                flex-direction: column;
                border-radius: 0;
                box-shadow: none;
            }
            .sidebar-menu {
                order: 2;
                width: 100%;
                border-radius: 0;
                border-top: 1px solid var(--border-color);
                padding: 8px 0 env(safe-area-inset-bottom);
                flex-direction: row;
                justify-content: space-around;
                align-items: center;
                height: auto;
                flex-shrink: 0;
                position: fixed;
                bottom: 0;
                left: 0;
                z-index: 100;
                background-color: var(--bg-primary);
            }
            .main-content-area {
                border-radius: 0;
            }

            .sidebar-menu .sidebar-header,
            .sidebar-menu .sidebar-footer {
                display: none;
            }

            .sidebar-menu .tabs-container {
                padding: 0;
                flex-grow: 1;
                width: 100%;
            }

            .sidebar-menu .tab-button {
                flex-direction: column;
                flex-basis: 0;
                flex-grow: 1;
                font-size: 12px;
                padding: var(--spacing-sm);
                min-width: 60px;
                height: 56px;
                justify-content: center;
                gap: 4px;
            }
            .sidebar-menu .tab-button::before {
                display: none;
            }

            .auth-card {
                padding: var(--spacing-xl) var(--spacing-lg);
            }

            /* 6. Botão de Tema e Logout para Mobile */
            .mobile-settings-actions {
                display: flex;
                flex-direction: column;
                gap: var(--spacing-md);
                margin-top: var(--spacing-xl);
                padding-top: var(--spacing-md);
                border-top: 1px solid var(--border-color);
            }

            .mobile-settings-actions .button-secondary {
                width: 100%;
                justify-content: center;
                font-size: 1rem;
                padding: var(--spacing-md);
            }
        }

        @media (min-width: 769px) {
            .mobile-settings-actions {
                display: none;
            }
        }
    </style>
    
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&family=Roboto:wght@400;500;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" as="style" onload="this.rel='stylesheet'">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&family=Roboto:wght@400;500;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&family=Roboto:wght@400;500;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    </noscript>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.webmanifest">
</head>
<body class="light-mode">

    <div id="globalLoader" class="global-loader" aria-live="assertive" aria-busy="true" aria-label="Carregando">
        <img id="loader-eixa" src="./assets/img/eixa.svg" alt="Carregando EIXA" />
    </div>

    <div id="appContainer" class="app-container">
        
        <aside id="sidebarMenu" class="sidebar-menu" style="display: none;">
            <div class="sidebar-header">
                <div class="sidebar-top-section">
                    <div class="header-eixa">
                        <img src="./assets/img/eixa.svg" alt="EIXA Logo" />
                        <span class="logo-text">EIXA</span>
                    </div>
                    <button id="sidebarToggleBtn" class="icon-button sidebar-toggle-btn" aria-label="Recolher ou Expandir Menu de Navegação">
                        <i class="material-icons">menu_open</i>
                    </button>
                </div>
                <div id="currentDateTimeDisplay" class="current-datetime-display"></div>
            </div>
            
            <nav class="tabs-container" role="tablist">
                <button class="tab-button active" data-target-view="chat" role="tab" aria-selected="true" aria-controls="chatViewContent" tabindex="0">
                    <i class="material-icons">chat_bubble</i><span class="tab-text">Chat</span>
                </button>
                <button class="tab-button" data-target-view="agenda" role="tab" aria-selected="false" aria-controls="agendaViewContent" tabindex="-1"> 
                    <i class="material-icons">calendar_month</i><span class="tab-text">Agenda</span>
                </button>
                <button class="tab-button" data-target-view="projetos" role="tab" aria-selected="false" aria-controls="projetosViewContent" tabindex="-1">
                    <i class="material-icons">folder_open</i><span class="tab-text">Projetos</span>
                </button>
                <button class="tab-button" data-target-view="emotionalMemories" role="tab" aria-selected="false" aria-controls="emotionalMemoriesViewContent" tabindex="-1">
                    <i class="material-icons">psychology_alt</i><span class="tab-text">Memórias</span>
                </button>
                <button class="tab-button" data-target-view="longTermMemory" role="tab" aria-selected="false" aria-controls="longTermMemoryViewContent" tabindex="-1">
                    <i class="material-icons">self_improvement</i><span class="tab-text">Perfil</span>
                </button>
            </nav>

            <div class="sidebar-footer">
                <div id="userDisplayArea" class="user-info-bar" style="display: none;">
                    <span id="welcomeMessage" class="sr-only"></span>
                    <strong id="userName"></strong>
                    <button id="signOutBtn" class="icon-button" aria-label="Sair da conta">
                        <i class="material-icons">logout</i>
                    </button>
                </div>
                <div class="app-settings-buttons">
                    <button id="themeToggleBtn" class="icon-button" aria-label="Alternar Tema Escuro/Claro">
                        <i class="material-icons">dark_mode</i>
                    </button>
                </div>
            </div>
        </aside>

        <main id="mainContentArea" class="main-content-area" role="main" style="display: none;"></main>

        <section id="authSection" class="auth-section" aria-modal="true" role="dialog" aria-label="Autenticação de Usuário">
            <div class="auth-card">
                <div class="auth-header">
                    <div class="header-eixa">
                        <img src="./assets/img/eixa.svg" alt="EIXA Logo" />
                        <span>EIXA</span>
                    </div>
                    <h1 class="auth-card-title">Acesse sua central de inteligência</h1>
                    <p class="auth-card-subtitle">e comece a organizar seu fluxo mental.</p>
                </div>
                
                <div id="manualAuthContainer">
                    <div class="input-group">
                        <input type="email" id="emailInput" placeholder="Seu email" required autocomplete="email">
                    </div>
                    <div class="input-group">
                        <input type="password" id="passwordInput" placeholder="Sua senha" required minlength="6" autocomplete="current-password">
                    </div>
                    <div id="authErrorMessage" class="error-message" role="alert" aria-live="assertive" style="display:none;"></div>
                    <div class="auth-buttons-group">
                        <button id="emailLoginBtn" class="button-primary auth-button">Entrar com Email e Senha</button>
                        <button id="emailSignupBtn" class="button-secondary auth-button">Cadastrar com Email e Senha</button>
                        <div class="divider">OU</div>
                        <button id="googleLoginBtn" class="auth-button google-button">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Ícone do Google" class="google-icon">
                            Entrar com Google
                        </button>
                    </div>
                </div>
            </div>
        </section>
        
    </div> 
    <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>

    <div id="editProjectModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="editProjectModalTitle" tabindex="-1"></div>
    <div id="addTaskModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="addTaskModalTitle" tabindex="-1"></div>
    <div id="editRoutineModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="editRoutineModalTitle" tabindex="-1"></div>
    <div id="confirmationModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmationModalTitle" tabindex="-1"></div>
    
    <template id="views-template">
        <div id="chatViewContent" class="view-content" role="tabpanel" aria-labelledby="chat-tab">
            <div id="chatDisplay" class="chat-display" role="log">
                <div class="message ai-message">
                    <div class="ai-avatar"><img src="./assets/img/eixa.svg" alt="EIXA IA" /></div>
                    <div class="message-content">Olá! Eu sou a EIXA. Como posso te ajudar a organizar suas ideias e projetos hoje?</div>
                    <button class="icon-button copy-button" aria-label="Copiar mensagem">
                        <i class="material-icons">content_copy</i>
                    </button>
                </div>
            </div>
            <div class="chat-input-area">
                <div id="loadingIndicator" class="loading-indicator" style="display: none;">
                    <img src="./assets/img/eixa.svg" alt="EIXA pensando" style="width: 24px; height: 24px; animation: fillPulse 2.5s ease-in-out infinite;" />
                    <span class="sr-only" id="chatAiThinkingSrOnly"></span>
                    <span id="chatAiThinkingVisible"></span>
                </div>
                <div id="suggestedTasksContainer" class="suggested-sections" style="display: none;">
                    <h3><i class="material-icons">checklist</i> <span id="suggestedTasksTitleSpan" class="section-title-text"></span></h3>
                    <ul id="suggestedTasksList"></ul>
                </div>
                <div id="suggestedProjectsContainer" class="suggested-sections" style="display: none;">
                    <h3><i class="material-icons">create_new_folder</i> <span id="suggestedProjectsTitleSpan" class="section-title-text"></span></h3>
                    <div id="suggestedProjectsCards" class="cards-grid"></div>
                </div>

                <div id="confirmationArea" class="confirmation-message" style="display: none;">
                    <p id="confirmationText"></p>
                    <div class="confirmation-actions">
                        <button id="confirmYesBtnChat" class="confirm-yes">Sim</button>
                        <button id="confirmNoBtnChat" class="confirm-no">Não</button>
                    </div>
                </div>

                <div id="inputWrapper" class="input-wrapper">
                    <button id="fileUploadBtn" class="icon-button file-upload-button" aria-label="Anexar Arquivo">
                        <i class="material-icons">attach_file</i>
                    </button>
                    <div class="attachment-info" style="display: none;">
                        <span class="file-name-display" aria-live="polite"></span>
                        <button class="icon-button attachment-clear-icon" aria-label="Remover arquivo anexado">
                            <i class="material-icons">close</i>
                        </button>
                    </div>
                    <input type="file" id="fileInput" class="hidden-input" aria-label="Selecione um arquivo para upload">
                    <textarea id="messageInput" placeholder="Converse com a EIXA..." rows="1" aria-label="Caixa de texto para digitar mensagem"
                                 autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" inputmode="text" name="messageInput"></textarea>
                    <button id="sendMessageBtn" class="icon-button send-message-button" aria-label="Enviar Mensagem">
                        <i class="material-icons">send</i>
                    </button>
                </div>
            </div>
        </div>
        <div id="agendaViewContent" class="view-content" role="tabpanel" aria-labelledby="agenda-tab"> 
            <header class="view-header">
                <h2 class="view-content-title">Minha Agenda</h2> 
                <button id="openAddTaskModalBtn" class="add-action-button" aria-label="Adicionar Nova Tarefa" title="Adicionar Nova Tarefa">
                    <i class="material-icons">add</i>
                </button>
                <button id="openAddRoutineModalBtn" class="add-action-button" aria-label="Criar Nova Rotina" title="Criar Nova Rotina">
                    <i class="material-icons">add_alarm</i> 
                </button>
                <button id="syncGoogleCalendarBtnAgenda" class="add-action-button" aria-label="Sincronizar Google Calendar" title="Sincronizar Google Calendar">
                    <i class="material-icons">sync</i>
                </button>
            </header>
            <div id="agendaDisplay" class="content-display-area"> 
            </div>
        </div>
        <div id="projetosViewContent" class="view-content" role="tabpanel" aria-labelledby="projetos-tab">
            <header class="view-header">
                <h2 class="view-content-title">Projetos</h2>
                <button id="openAddProjectModalBtn" class="add-action-button" aria-label="Adicionar Novo Projeto" title="Adicionar Novo Projeto">
                    <i class="material-icons">add</i>
                </button>
            </header>
            <div id="projetosDisplay" class="content-display-area"></div>
        </div>
        <div id="emotionalMemoriesViewContent" class="view-content" role="tabpanel" aria-labelledby="emotional-memories-tab">
            <header class="view-header">
                <h2 class="view-content-title">Memórias Emocionais</h2>
            </header>
            <p class="view-intro">Registros de momentos e emoções para sua reflexão.</p>
            <div id="emotionalMemoriesDisplay" class="content-display-area cards-grid"></div>
        </div>
        <div id="diagnosticoViewContent" class="view-content" role="tabpanel" aria-labelledby="diagnostico-tab">
            <header class="view-header">
                <h2 class="view-content-title">Diagnóstico Semanal</h2>
            </header>
            <p class="view-intro">Seus checkpoints e autoavaliações para acompanhar sua evolução.</p>
            <div id="diagnosticoDisplay" class="content-display-area"></div>
        </div>
        <div id="longTermMemoryViewContent" class="view-content" role="tabpanel" aria-labelledby="long-term-memory-tab">
            <header class="view-header">
                <h2 class="view-content-title">Memória de Longo Prazo (Perfil)</h2>
            </header>
            <p class="view-intro">O que a EIXA aprendeu sobre você para personalização profunda.</p>
            <div id="longTermMemoryDisplay" class="content-display-area"></div>
        </div>
        <!-- NOVO: DIV PARA TEMPLATES DE ROTINA. NÃO É UMA ABA, MAS UMA VIEW SECUNDÁRIA -->
        <div id="rotinasTemplatesViewContent" class="view-content" role="tabpanel" aria-labelledby="rotinas-templates-tab" style="display: none;">
            <header class="view-header">
                <h2 class="view-content-title">Templates de Rotina</h2>
                <button id="openAddRoutineModalBtnSecondary" class="add-action-button" aria-label="Criar Novo Template de Rotina" title="Criar Novo Template de Rotina">
                    <i class="material-icons">add_alarm</i> 
                </button>
            </header>
            <div id="rotinasDisplay" class="content-display-area cards-grid"></div>
        </div>
    </template>
    
    <!-- NOVO TEMPLATE PARA TAREFAS/EVENTOS NA LINHA DO TEMPO DA AGENDA -->
    <template id="agenda-event-block-template">
        <div class="agenda-event-block" tabindex="0">
            <span class="event-time"></span>
            <span class="event-description"></span>
            <div class="event-icons">
                <!-- Ícones para origem e tipo (GC, Rotina, Tarefa Concluída) -->
            </div>
        </div>
    </template>

    <template id="project-card-template">
        <div class="project-card" tabindex="0">
            <h4></h4>
            <p class="project-description"></p>
            <div class="project-details">
                <strong>Status:</strong> <span class="project-status-display"></span>
                <div class="project-deadline-container"><strong>Prazo:</strong> <span class="project-deadline"></span></div>
            </div>
            <strong>Microtarefas:</strong>
            <ul class="project-microtasks-list"></ul>
            <div class="card-actions">
                <button class="icon-button edit-button" title="Editar Projeto" aria-label="Editar Projeto">
                    <i class="material-icons">edit</i>
                </button>
                <button class="icon-button delete-button" title="Excluir Projeto" aria-label="Excluir Projeto">
                    <i class="material-icons">delete_forever</i>
                </button>
            </div>
        </div>
    </template>
    <template id="routine-card-template"> 
        <div class="routine-card" tabindex="0">
            <h4><i class="material-icons">repeat</i> <span class="routine-name-display"></span></h4>
            <p class="routine-description"></p>
            <p class="routine-days"><strong>Aplica-se a:</strong> <span class="routine-days-display"></span></p>
            <strong>Itens da Rotina:</strong>
            <ul class="routine-schedule-list"></ul>
            <div class="card-actions">
                <button class="icon-button edit-button" title="Editar Rotina" aria-label="Editar Rotina">
                    <i class="material-icons">edit</i>
                </button>
                <button class="icon-button apply-button" title="Aplicar Rotina ao Dia" aria-label="Aplicar Rotina ao Dia">
                    <i class="material-icons">calendar_today</i>
                </button>
                <button class="icon-button delete-button" title="Excluir Rotina" aria-label="Excluir Rotina">
                    <i class="material-icons">delete_forever</i>
                </button>
            </div>
        </div>
    </template>
    <template id="microtask-edit-template">
        <div class="modal-microtask-item">
            <input type="checkbox" class="edit-microtask-completed" aria-label="Marcar microtarefa como concluída">
            <input type="text" class="edit-microtask-description" placeholder="Descreva a microtarefa..." aria-label="Descrição da microtarefa">
            <button class="icon-button remove-microtask-button" title="Remover" aria-label="Remover microtarefa">
                <i class="material-icons">delete</i>
            </button>
        </div>
    </template>
    <template id="routine-item-edit-template">
        <div class="modal-routine-item">
            <input type="time" class="edit-routine-item-time" required aria-label="Hora da atividade">
            <input type="number" class="edit-routine-item-duration" min="0" placeholder="Minutos" aria-label="Duração em minutos">
            <input type="text" class="edit-routine-item-description" placeholder="Descreva a atividade..." required aria-label="Descrição da atividade">
            <button class="icon-button remove-routine-item-button" title="Remover" aria-label="Remover item da rotina">
                <i class="material-icons">delete</i>
            </button>
        </div>
    </template>
    <template id="diagnostic-card-template">
        <div class="diagnostic-card" tabindex="0">
            <p class="diagnostic-timestamp"><strong>Checkpoint de:</strong> <span></span></p>
            <div class="diagnostic-category"><h4><i class="material-icons">checklist</i> Conquistas</h4><ul class="diagnostic-conquistas-list"></ul></div>
            <div class="diagnostic-category"><h4><i class="material-icons">psychology_alt</i> Padrões Negativos</h4><ul class="diagnostic-padroes-negativos-list"></ul></div>
            <div class="diagnostic-category"><h4><i class="material-icons">folder_open</i> Alertas</h4><ul class="diagnostic-alertas-list"></ul></div>
            <p class="diagnostic-summary-label"><strong>Resumo da IA:</strong></p><p class="diagnostic-summary"></p>
        </div>
    </template>
    <template id="emotional-memory-card-template">
        <div class="emotional-memory-card" tabindex="0">
            <p class="memory-timestamp"><span></span></p>
            <p class="memory-content"></p>
            <div class="memory-tags-list"></div>
        </div>
    </template>
    <template id="long-term-profile-template">
        <div class="long-term-profile-display content-display-area">
            <h3>Informações Essenciais</h3>
            <p><strong>Nome:</strong> <span data-field="name"></span></p>
            <p><strong>Localidade:</strong> <span data-field="locale"></span></p>
            <p><strong>Fuso Horário:</strong> <span data-field="timezone"></span></p>
            
            <h3>Aspectos Psicológicos e Comportamentais</h3>
            <div class="profile-section">
                <h4>Traços de Personalidade</h4><ul data-field="personality_traits"></ul>
            </div>
            <div class="profile-section">
                <h4>Condições e Diagnósticos</h4><ul data-field="diagnoses_and_conditions"></ul>
            </div>
            <div class="profile-section">
                <h4>Padrões Comportamentais Históricos</h4><ul data-field="historical_behavioral_patterns"></ul>
            </div>
            <div class="profile-section">
                <h4>Mecanismos de Coping</h4><ul data-field="coping_mechanisms"></ul>
            </div>
            
            <h3>Estilo Cognitivo</h3>
            <ul data-field="cognitive_style"></ul>
            
            <h3>Preferências de Comunicação com a EIXA</h3>
            <p><strong>Tom Preferencial:</strong> <span data-field="tone_preference"></span></p>
            <p><strong>Estilo de Intervenção:</strong> <span data-field="intervention_style"></span></p>
            <div class="profile-section">
                <h4>Ações Esperadas da EIXA</h4><ul data-field="expected_eixa_actions"></ul>
            </div>
            <div class="profile-section">
                <h4>Regras Específicas (Não Fazer)</h4><ul data-field="specific_no_gos"></ul>
            </div>
            
            <h3>Contexto de Vida</h3>
            <p><strong>Profissional:</strong> <span data-field="professional"></span></p>
            <p><strong>Relacionamentos:</strong> <span data-field="personal_relationships"></span></p>
            <p><strong>Saúde e Bem-Estar:</strong> <span data-field="health_and-wellness"></span></p>

            <!-- NOVO: Seção de Integrações com Google Calendar - NO PERFIL -->
            <h3>Integrações</h3>
            <div class="profile-section">
                <h4>Google Calendar</h4>
                <p class="google-calendar-status-text" id="googleCalendarStatus">Status: Verificando...</p>
                <button id="connectGoogleCalendarBtn" class="connect-google-button" style="display: none;">
                    <i class="material-icons">calendar_today</i> Conectar Google Calendar
                </button>
                <button id="syncGoogleCalendarBtn" class="connect-google-button" style="display: none;">
                    <i class="material-icons">sync</i> Sincronizar Google Calendar
                </button>
                <button id="disconnectGoogleCalendarBtn" class="button-secondary" style="display: none;">
                    <i class="material-icons">link_off</i> Desconectar Google Calendar
                </button>
                <!-- Botão para ver templates de rotina, se for manter a visualização dos TEMPLATES de rotina (e não a agenda) -->
                <button id="viewRoutineTemplatesBtn" class="button-secondary" style="margin-top: var(--spacing-md);">
                    <i class="material-icons">repeat</i> Ver Meus Templates de Rotina
                </button>
            </div>

            <!-- Adição: Botões de Tema e Logout para Mobile -->
            <div class="mobile-settings-actions">
                <button id="mobileThemeToggleBtn" class="button-secondary" aria-label="Alternar Tema Escuro/Claro">
                    <i class="material-icons">dark_mode</i> <span>Alterar Tema</span>
                </button>
                <button id="mobileSignOutBtn" class="button-secondary" aria-label="Sair da conta">
                    <i class="material-icons">logout</i> <span>Sair</span>
                </button>
            </div>
        </div>
    </template>
    
    <template id="editProjectModalTemplate">
        <div class="modal-content">
            <h3 id="editProjectModalTitle">Editar Projeto</h3>
            <button class="icon-button close-button" title="Fechar" aria-label="Fechar Modal">×</button>
            <label for="editProjectName">Nome do Projeto</label>
            <input type="text" id="editProjectName" required aria-label="Nome do Projeto">
            <label for="editProjectDescription">Descrição</label>
            <textarea id="editProjectDescription" rows="3" aria-label="Descrição do Projeto"></textarea>
            <div class="modal-row">
                <div class="modal-field">
                    <label for="editProjectStatus">Status</label>
                    <select id="editProjectStatus" aria-label="Status do Projeto">
                        <option value="open">Aberto</option>
                        <option value="in_progress">Em Progresso</option>
                        <option value="on_hold">Pausado</option>
                        <option value="completed">Concluído</option>
                        <option value="cancelled">Cancelado</option>
                        <option value="archived">Arquivado</option>
                    </select>
                </div>
                <div class="modal-field">
                    <label for="editProjectDeadline">Prazo Final</label>
                    <input type="date" id="editProjectDeadline" aria-label="Prazo Final do Projeto">
                </div>
            </div>
            <label>Microtarefas</label>
            <div id="editProjectMicrotasks"></div>
            <button id="addMicrotaskModalBtn" class="button-secondary" aria-label="Adicionar Microtarefa">
                <i class="material-icons">add</i> <span id="addMicrotaskButtonLabelSpan"></span>
            </button>
            <div class="button-group">
                <button id="editProjectCancelBtn" class="cancel-button" aria-label="Cancelar"></button>
                <button id="saveProjectChangesBtn" class="save-button" aria-label="Salvar Alterações"></button>
            </div>
        </div>
    </template>
    <template id="addTaskModalTemplate">
        <div class="modal-content">
            <h3 id="addTaskModalTitle">Adicionar Nova Tarefa</h3>
            <button class="icon-button close-button" title="Fechar" aria-label="Fechar Modal">×</button>
            <label for="newTaskDescription">Descrição</label>
            <input type="text" id="newTaskDescription" placeholder="Ex: Preparar relatório semanal" required aria-label="Descrição da Nova Tarefa">
            <div class="modal-row">
                <div class="modal-field">
                    <label for="newTaskDate">Data</label>
                    <input type="date" id="newTaskDate" required aria-label="Data da Nova Tarefa">
                </div>
                <div class="modal-field">
                    <label for="newTaskTime">Hora</label>
                    <input type="time" id="newTaskTime" value="09:00" required aria-label="Hora da Nova Tarefa">
                </div>
            </div>
            <label for="newTaskDuration">Duração (minutos)</label>
            <input type="number" id="newTaskDuration" min="0" value="60" aria-label="Duração da Nova Tarefa em minutos">
            <div class="button-group">
                <button id="addTaskCancelBtn" class="cancel-button" aria-label="Cancelar"></button>
                <button id="saveNewTaskBtn" class="save-button" aria-label="Salvar Nova Tarefa"></button>
            </div>
        </div>
    </template>
    <template id="editRoutineModalTemplate">
        <div class="modal-content">
            <h3 id="editRoutineModalTitle">Criar/Editar Rotina</h3>
            <button class="icon-button close-button" title="Fechar" aria-label="Fechar Modal">×</button>
            <label for="routineName">Nome da Rotina</label>
            <input type="text" id="routineName" required placeholder="Ex: Rotina Matinal" aria-label="Nome da Rotina">
            <label for="routineDescription">Descrição</label>
            <textarea id="routineDescription" rows="2" placeholder="Ex: Preparação para o dia de trabalho" aria-label="Descrição da Rotina"></textarea>
            <label>Aplica-se aos Dias da Semana</label>
            <div id="routineDaysOfWeek" class="modal-row" style="flex-wrap: wrap;">
                <input type="checkbox" id="routineMon" data-day="MONDAY"><label for="routineMon">Seg</label>
                <input type="checkbox" id="routineTue" data-day="TUESDAY"><label for="routineTue">Ter</label>
                <input type="checkbox" id="routineWed" data-day="WEDNESDAY"><label for="routineWed">Qua</label>
                <input type="checkbox" id="routineThu" data-day="THURSDAY"><label for="routineThu">Qui</label>
                <input type="checkbox" id="routineFri" data-day="FRIDAY"><label for="routineFri">Sex</label>
                <input type="checkbox" id="routineSat" data-day="SATURDAY"><label for="routineSat">Sáb</label>
                <input type="checkbox" id="routineSun" data-day="SUNDAY"><label for="routineSun">Dom</label>
            </div>
            <label for="routineRecurrenceRule">Regra de Recorrência (ex: Diário, Semanal, Mensal)</label>
            <input type="text" id="routineRecurrenceRule" placeholder="Ex: Semanalmente, Toda terça-feira" aria-label="Regra de Recorrência">
            <label>Itens da Rotina</label>
            <div id="routineItemsContainer"></div>
            <button id="addRoutineItemModalBtn" class="button-secondary" aria-label="Adicionar Item à Rotina">
                <i class="material-icons">add</i> Adicionar Item
            </button>
            <div class="button-group">
                <button id="routineCancelBtn" class="cancel-button" aria-label="Cancelar"></button>
                <button id="saveRoutineBtn" class="save-button" aria-label="Salvar Rotina"></button>
            </div>
        </div>
    </template>
    <template id="confirmationModalTemplate">
        <div class="modal-content">
            <h3 id="confirmationModalTitle">Confirmação</h3>
            <button class="icon-button close-button" title="Fechar" aria-label="Fechar Modal">×</button>
            <p id="confirmationMessage"></p>
            <div class="button-group">
                <button id="confirmNoBtn" class="cancel-button" aria-label="Não Confirmar"></button>
                <button id="confirmYesBtn" class="save-button" aria-label="Confirmar"></button>
            </div>
        </div>
    </template>

    <a id="eixaIconFab" href="#chat" class="eixa-icon-fab" style="display: none;">
      <img src="./assets/img/eixa.svg" alt="EIXA Icon" />
    </a>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script>
        'use strict';

        // --- GLOBAL UTILS (Moved outside DOMContentLoaded to prevent ReferenceReferences) ---
        let elements = {}; 
        let globalLoaderTimeout;
        function showGlobalLoader() { 
            console.log("DEBUG: showGlobalLoader called.");
            if (elements.globalLoader) {
                elements.globalLoader.style.display = 'flex';
                clearTimeout(globalLoaderTimeout);
                globalLoaderTimeout = setTimeout(() => {
                    elements.globalLoader.classList.add('active'); 
                    elements.globalLoader.setAttribute('aria-busy', 'true');
                }, 50);
            }
        }
        function hideGlobalLoader() { 
            console.log("DEBUG: hideGlobalLoader called.");
            clearTimeout(globalLoaderTimeout);
            if (elements.globalLoader) {
                elements.globalLoader.classList.remove('active'); 
                elements.globalLoader.style.display = 'none';
                elements.globalLoader.setAttribute('aria-busy', 'false');
            }
        }

        // Toasts (Floating Notifications)
        function showToast(message, type = 'info', duration = 3500) {
            if (!elements.toastContainer) { console.warn("DEBUG: Toast container not found."); return; }
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            elements.toastContainer.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }

        // Display Authentication Errors
        function displayAuthError(message) {
            if (!message || message.trim() === '') {
                message = '';
            }
            if (elements.authErrorMessage) {
                elements.authErrorMessage.textContent = message;
                elements.authErrorMessage.style.display = message ? 'block' : 'none'; 
            }
            if (message) {
                console.error("DEBUG: Auth Error:", message);
            }
        }

        // HTML Sanitization to prevent XSS and Markdown parsing to HTML
        function escapeHTML(str) {
            const div = document.createElement("div");
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        function parseMarkdownToHtml(text) {
            if (!text) return '';
            let html = escapeHTML(text); 
            html = html
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') 
                .replace(/\*(.*?)\*/g, '<em>$1</em>') 
                .replace(/^- (.*$)/gim, '<ul><li>$1</li></ul>')   
                .replace(/<\/ul>\s*<ul>/g, '')  
                .replace(/\n(?=<h[1-6]|<ul|<ol>)/g, '')   
                .replace(/\n/g, '<br>');   
            return html;
        }

        // Date Formatting
        function formatDate(isoDateString) {
            if (!isoDateString) return 'N/A';
            try {
                const dateObj = new Date(isoDateString + 'T00:00:00'); 
                if (isNaN(dateObj.getTime())) { console.error("DEBUG: Invalid date object created from:", isoDateString); return 'Data Inválida'; }
                return dateObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            } catch (e) {
                console.error("DEBUG: Error formatting date:", isoDateString, e);
                return 'Formato Inválido';
            }
        }
        
        function formatDateTime(timestamp) {
            if (!timestamp) return 'N/A';
            try {
                let dateObj;
                if (typeof timestamp === 'object' && timestamp._seconds !== undefined) { 
                    dateObj = new Date(timestamp._seconds * 1000);
                } else if (typeof timestamp === 'string') { 
                    dateObj = new Date(timestamp);
                } else {
                    console.warn("DEBUG: Unknown timestamp format:", typeof timestamp, timestamp);
                    return 'N/A';
                }
                
                if (isNaN(dateObj.getTime())) { console.error("DEBUG: Invalid date object from timestamp:", timestamp); return 'Data Inválida'; }
                return dateObj.toLocaleString('pt-BR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                console.error("DEBUG: Error formatting datetime:", timestamp, e);
                return 'Formato Inválido';
            }
        }


        // Generate Personalized Greeting
        function getPersonalizedGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) return "Bom dia,";
            if (hour < 18) return "Boa tarde,";
            return "Boa noite,";
        }

        // Functions for Modals (global to be called directly from HTML)
        let activeModalElement = null;  
        function openModal(modalId) {  
            console.log("DEBUG: openModal called for:", modalId);
            const modal = elements[modalId];
            if (modal) {
                setTimeout(() => {
                    modal.classList.add('active');
                    modal.focus();  
                    activeModalElement = modal; 

                    const modalContent = modal.querySelector('.modal-content');
                    if (modalContent) {
                        const existingHandler = modal.dataset.overlayClickHandler;
                        if (!existingHandler) {
                            const handler = function(e) {
                                if (e.target === modal) {   
                                    closeModal(modalId);
                                    modal.removeEventListener('click', handler);    
                                    delete modal.dataset.overlayClickHandler;
                                }
                            };
                            modal.addEventListener('click', handler);
                            modal.dataset.overlayClickHandler = 'true'; 
                        }

                        const existingStopPropHandler = modalContent.dataset.stopPropHandler;
                        if (!existingStopPropHandler) {
                            const stopProp = function(e) { e.stopPropagation(); };
                            modalContent.addEventListener('click', stopProp);
                            modalContent.dataset.stopPropHandler = 'true'; 
                        }
                    }
                }, 0);  
            } else {
                console.error("DEBUG: Modal element not found:", modalId);
            }
        }
        function closeModal(modalId) { 
            console.log("DEBUG: closeModal called for:", modalId);
            const modal = elements[modalId];
            if (modal) {
                modal.classList.remove('active');
                activeModalElement = null;  
            } else {
                console.warn("DEBUG: Attempted to close non-existent modal:", modalId);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DEBUG: DOMContentLoaded fired. Starting application initialization.");

            // --- CONFIGURATION AND GLOBAL STATE ---
            const config = {
                CLOUD_FUNCTION_URL: "https://eixa-760851989407.us-east1.run.app/interact",
                CLOUD_FUNCTION_AUTH_URL: "https://eixa-760851989407.us-east1.run.app/auth/google",
                CLOUD_FUNCTION_OAUTH_CALLBACK_URL: "https://eixa-760851989407.us-east1.run.app/oauth2callback",
                firebaseConfig: {
                    apiKey: "AIzaSyAKEdwGJFjAXyY3vQUMm0sCIvdSfs-WInw",
                    authDomain: "arquitetodadivulgacao.firebaseapp.com",
                    projectId: "arquitetodadivulgacao",
                    storageBucket: "arquitetodadivulgacao.firebasestorage.app",
                    messagingSenderId: "760851989407",
                    appId: "1:760851989407:web:485fc9e2d0328b479473aa"
                },
                MAX_FILE_SIZE: 10 * 1024 * 1024,
                FRONTEND_URL: "https://eixa.web.app" 
            };

            // Centralization of strings for easy maintenance and internationalization (i18n)
            const i18nStrings = {
                loginError: 'Erro de login:',
                signupError: 'Erro de cadastro:',
                googleLoginError: 'Erro de login com Google:',
                authMissingFields: 'Por favor, insira e-mail e senha.',
                fileTooLarge: 'Arquivo muito grande (máx 10MB).',
                unauthenticated: 'Usuário não autenticado.',
                apiError: 'Falha na comunicação:',
                confirmTaskDelete: 'Tem certeza que deseja excluir a tarefa',
                confirmProjectDelete: 'Tem certeza que deseja excluir o projeto',
                confirmRoutineDelete: 'Tem certeza que deseja excluir a rotina',
                taskDescriptionAndDateRequired: 'Descrição, data e hora são obrigatórias.',
                routineNameRequired: 'O nome da rotina é obrigatório.',
                routineItemDescriptionTimeRequired: 'Todos os itens da rotina devem ter descrição, hora e duração.',
                taskAddSuccess: 'Tarefa adicionada com sucesso!',
                routineAddSuccess: 'Rotina salva com sucesso!',
                routineApplySuccess: 'Rotina aplicada com sucesso!',
                taskCreateError: 'Erro ao criar tarefa.',
                routineCreateError: 'Erro ao criar rotina.',
                routineApplyError: 'Erro ao aplicar rotina.',
                aiProcessing: 'EIXA está pensando...',
                suggestedTasksTitle: 'Tarefas Sugeridas',
                suggestedProjectsTitle: 'Projetos Sugeridos',
                newTaskButtonLabel: 'Nova Tarefa',
                newProjectButtonLabel: 'Novo Projeto',   
                newRoutineButtonLabel: 'Nova Rotina',
                forceCheckpointButtonLabel: 'Forçar Checkpoint',   
                addMicrotaskButtonLabel: 'Adicionar',
                addRoutineItemButtonLabel: 'Adicionar Item',
                cancelButtonLabel: 'Cancelar',
                saveChangesButtonLabel: 'Salvar Alterações',
                saveTaskButtonLabel: 'Salvar Tarefa',
                saveRoutineButtonLabel: 'Salvar Rotina',
                yesButtonLabel: 'Sim',
                noButtonLabel: 'Não',
                noDataMessageAgenda: 'Nenhuma tarefa agendada. Que tal criar uma agora?', 
                noDataMessageRoutines: 'Nenhuma rotina salva. Que tal criar uma nova?', 
                noDataMessageProjects: 'Nenhum projeto encontrado. Converse com a EIXA para criar um!',
                noDataMessageDiagnostic: 'Nenhum diagnóstico disponível. Interaja mais para gerar seu primeiro checkpoint.',   
                defaultAiGreeting: 'Olá! Eu sou a EIXA. Como posso te ajudar a organizar suas ideias e projetos hoje?',
                truncatedResponseWarning: '⚠️ A resposta pode estar incompleta, pois o modelo atingiu um limite.',
                offlineMessage: 'Você está offline. Verifique sua conexão.',
                onlineMessage: 'Conexão restabelecida.',
                invalidDate: 'Data Inválida',
                invalidDateFormat: 'Formato Inválido',
                copySuccess: 'Copiado!',
                copyError: 'Erro ao copiar.',
                noDataMessageEmotionalMemories: 'Nenhuma memória emocional registrada ainda. Converse com a EIXA para que ela comece a registrar suas emoções!',
                noDataMessageLongTermMemory: 'Perfil de longo prazo não disponível ou vazio. A EIXA precisa de mais interações para construir seu perfil.',
                connectGoogleCalendarStatusChecking: 'Status: Verificando conexão...',
                connectGoogleCalendarStatusConnected: 'Status: Conectado',
                connectGoogleCalendarStatusNotConnected: 'Status: Não Conectado',
                connectGoogleCalendarError: 'Erro ao conectar Google Calendar:',
                disconnectGoogleCalendarConfirm: 'Tem certeza que deseja desconectar sua conta Google da EIXA?',
                disconnectGoogleCalendarSuccess: 'Google Calendar desconectado.',
                disconnectGoogleCalendarError: 'Erro ao desconectar Google Calendar.',
                syncGoogleCalendarSuccess: 'Eventos do Google Calendar sincronizados!',
                syncGoogleCalendarError: 'Erro ao sincronizar Google Calendar.',
                confirmTaskMarkComplete: 'Marcar como CONCLUÍDA?',
                confirmTaskMarkPending: 'Marcar como PENDENTE?',
                confirmTaskDeleteInstance: 'Excluir APENAS esta tarefa?',
                viewRoutineTemplate: 'Ver/Editar Template da Rotina',
                noDataMessageDiagnostico: 'Nenhum diagnóstico disponível no momento. Continue usando a EIXA para gerar seus checkpoints!',
                acceptSuggestion: 'Aceitar',
                rejectSuggestion: 'Rejeitar',
                suggestionAccepted: 'Sugestão aceita!',
                suggestionRejected: 'Sugestão rejeitada.',
                applyRoutineToDay: 'Aplicar ao Dia',
                deleteRoutine: 'Excluir Rotina',
                confirmDeleteRoutine: 'Tem certeza que deseja excluir esta rotina?',
                routineDeleted: 'Rotina excluída com sucesso!',
                routineApplied: 'Rotina aplicada ao dia com sucesso!',
            };

            let currentUser = null; 
            let currentFileUpload = null; 
            let isSendingMessage = false; 
            let currentEditProjectId = null; 
            let currentEditRoutineId = null;
            let debugMode = false; 
            
            let currentTheme = localStorage.getItem('theme') || 
                               (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark-mode' : 'light-mode');
            
            let userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/Sao_Paulo';

            function updateClockDisplay() {
                // Apenas acessa se o elemento existir, o que será garantido por initializeDynamicDOMElements se a UI for construída
                if (elements.currentDateTimeDisplay) { 
                    const now = new Date();
                    const options = {
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit', second: '2-digit',
                        hour12: false,
                        timeZone: userTimezone 
                    };
                    const formattedDateTime = now.toLocaleString('pt-BR', options);
                    elements.currentDateTimeDisplay.textContent = formattedDateTime;
                }
            }

            // --- INITIALIZATION AND ELEMENT BINDING ---

            function initializeApp() {
                console.log("DEBUG: initializeApp started.");
                showGlobalLoader(); 
                try {
                    firebase.initializeApp(config.firebaseConfig); 
                    console.log("DEBUG: Firebase App initialized successfully.");
                } catch (e) {
                    console.error("DEBUG: FATAL: Firebase App initialization failed!", e);
                    document.body.innerHTML = `<div style="color: red; font-family: sans-serif; padding: 20px;">
                        <h1>Erro Crítico na Inicialização do Firebase</h1>
                        <p>Verifique a configuração do seu projeto Firebase (apiKey, authDomain, projectId, storageBucket).</p>
                        <p>Mensagem: ${e.message}</p>
                        </div>`;
                    hideGlobalLoader();
                    return; 
                }
                
                // 1. Inicializa elementos estáticos que SEMPRE estão no DOM
                initializeStaticDOMElements(); // AGORA CHAMA O NOME CORRETO
                
                // 2. Popula os modais (cujo *conteúdo* vem de templates, mas as divs dos modais são estáticas)
                if (elements.editProjectModal && elements.editProjectModalTemplate) {
                    elements.editProjectModal.innerHTML = elements.editProjectModalTemplate.content.cloneNode(true).innerHTML;
                }
                if (elements.addTaskModal && elements.addTaskModalTemplate) {
                    elements.addTaskModal.innerHTML = elements.addTaskModalTemplate.content.cloneNode(true).innerHTML;
                }
                if (elements.editRoutineModal && elements.editRoutineModalTemplate) {
                    elements.editRoutineModal.innerHTML = elements.editRoutineModalTemplate.content.cloneNode(true).innerHTML;
                }
                if (elements.confirmationModal && elements.confirmationModalTemplate) {
                    elements.confirmationModal.innerHTML = elements.confirmationModalTemplate.content.cloneNode(true).innerHTML;
                }

                // 3. Configura a autenticação (Firebase lida com o estado do usuário e chama initializeAppUIAndDisplay)
                setupAuth(); 
                
                // 4. Configura listeners e tema (alguns listeners dependem da UI principal, mas esses são para o ciclo de vida inicial)
                setupEventListeners(); // Esses são listeners globais no body ou window
                applyInitialTheme(); // Tema inicial para body e botões estáticos
                handleGoogleOAuthCallback(); // Para lidar com redirects de OAuth
                
                console.log("DEBUG: initializeApp finished.");
            }

            // FUNÇÃO PARA INICIALIZAR APENAS ELEMENTOS ESTÁTICOS (SEMPRE PRESENTES NO DOM)
            function initializeStaticDOMElements() { // NOME DA FUNÇÃO CORRIGIDO AQUI
                console.log("DEBUG: initializeStaticDOMElements started (static elements).");
                const staticElementIds = [
                    'globalLoader', 'appContainer', 'mainContentArea', 'authSection', 'sidebarMenu',
                    'toastContainer', 'emailInput', 'passwordInput', 'emailLoginBtn', 
                    'emailSignupBtn', 'googleLoginBtn', 'authErrorMessage', 'sidebarToggleBtn',
                    'userDisplayArea', 'userName', 'welcomeMessage', 'signOutBtn', 
                    'themeToggleBtn', 'loader-eixa', 'eixaIconFab', 
                    'editProjectModal', 'addTaskModal', 'editRoutineModal', 'confirmationModal',
                    'currentDateTimeDisplay' // Este é estático, está fora do views-template
                ];
                staticElementIds.forEach(id => {
                    const propName = id.replace(/-([a-z])/g, (g) => g[1].toUpperCase()); 
                    elements[propName] = document.getElementById(id);
                    if (!elements[propName]) {
                        console.warn(`DEBUG: Static element with ID '${id}' not found.`);
                    }
                });

                // Templates (as tags <template> são estáticas, seu conteúdo é dinâmico)
                elements.viewsTemplate = document.getElementById('views-template');
                elements.agendaEventBlockTemplate = document.getElementById('agenda-event-block-template');
                elements.projectCardTemplate = document.getElementById('project-card-template');
                elements.routineCardTemplate = document.getElementById('routine-card-template');
                elements.microtaskEditTemplate = document.getElementById('microtask-edit-template');
                elements.routineItemEditTemplate = document.getElementById('routine-item-edit-template');
                elements.diagnosticCardTemplate = document.getElementById('diagnostic-card-template');

                elements.emotionalMemoryCardTemplate = document.getElementById('emotional-memory-card-template');
                elements.longTermProfileTemplate = document.getElementById('long-term-profile-template');

                elements.editProjectModalTemplate = document.getElementById('editProjectModalTemplate');
                elements.addTaskModalTemplate = document.getElementById('addTaskModalTemplate');
                elements.editRoutineModalTemplate = document.getElementById('editRoutineModalTemplate');
                elements.confirmationModalTemplate = document.getElementById('confirmationModalTemplate');

                // Botões da sidebar (são estáticos no corpo do HTML)
                elements.tabButtons = document.querySelectorAll('.tab-button');
                console.log("DEBUG: initializeStaticDOMElements finished (static elements).");
            }

            // FUNÇÃO PARA INICIALIZAR ELEMENTOS DINÂMICOS (chamada APENAS DEPOIS que o template é anexado)
            function initializeDynamicDOMElementsInMainContent() {
                console.log("DEBUG: initializeDynamicDOMElementsInMainContent started. (Getting refs from mainContentArea)");
                
                // Elementos dentro de #chatViewContent
                elements.chatViewContent = document.getElementById('chatViewContent');
                elements.chatDisplay = document.getElementById('chatDisplay');
                elements.messageInput = document.getElementById('messageInput');
                elements.sendMessageBtn = document.getElementById('sendMessageBtn');
                elements.fileInput = document.getElementById('fileInput');
                elements.fileUploadBtn = document.getElementById('fileUploadBtn');
                elements.attachmentIcon = document.querySelector('#fileUploadBtn .material-icons');
                elements.attachmentClearIcon = document.querySelector('.attachment-info .material-icons');
                elements.attachmentInfoDiv = document.querySelector('.attachment-info');
                elements.fileNameDisplay = document.querySelector('.attachment-info .file-name-display');

                elements.loadingIndicator = document.getElementById('loadingIndicator');
                elements.chatAiThinkingSrOnly = document.getElementById('chatAiThinkingSrOnly');
                elements.chatAiThinkingVisible = document.getElementById('chatAiThinkingVisible');

                elements.suggestedTasksContainer = document.getElementById('suggestedTasksContainer');
                elements.suggestedTasksList = document.getElementById('suggestedTasksList');
                elements.suggestedProjectsContainer = document.getElementById('suggestedProjectsContainer');
                elements.suggestedProjectsCards = document.getElementById('suggestedProjectsCards');
                elements.suggestedTasksTitleSpan = document.getElementById('suggestedTasksTitleSpan');
                elements.suggestedProjectsTitleSpan = document.getElementById('suggestedProjectsTitleSpan');

                elements.confirmationArea = document.getElementById('confirmationArea');
                elements.confirmationText = document.getElementById('confirmationText');
                elements.confirmYesBtnChat = document.getElementById('confirmYesBtnChat');
                elements.confirmNoBtnChat = document.getElementById('confirmNoBtnChat');

                elements.inputWrapper = document.getElementById('inputWrapper');

                // Elementos dentro de #agendaViewContent
                elements.agendaViewContent = document.getElementById('agendaViewContent');
                elements.agendaDisplay = document.getElementById('agendaDisplay');
                elements.openAddTaskModalBtn = document.getElementById('openAddTaskModalBtn');
                elements.openAddRoutineModalBtn = document.getElementById('openAddRoutineModalBtn');
                elements.syncGoogleCalendarBtnAgenda = document.getElementById('syncGoogleCalendarBtnAgenda');
                
                // Elementos dentro de #rotinasTemplatesViewContent
                elements.rotinasTemplatesViewContent = document.getElementById('rotinasTemplatesViewContent');
                elements.rotinasDisplay = document.getElementById('rotinasDisplay');
                elements.openAddRoutineModalBtnSecondary = document.getElementById('openAddRoutineModalBtnSecondary');
                
                // Elementos dentro de #projetosViewContent
                elements.projetosViewContent = document.getElementById('projetosViewContent');
                elements.projetosDisplay = document.getElementById('projetosDisplay');
                elements.openAddProjectModalBtn = document.getElementById('openAddProjectModalBtn');
                
                // Elementos dentro de #emotionalMemoriesViewContent
                elements.emotionalMemoriesViewContent = document.getElementById('emotionalMemoriesViewContent');
                elements.emotionalMemoriesDisplay = document.getElementById('emotionalMemoriesDisplay');
                
                // Elementos dentro de #diagnosticoViewContent
                elements.diagnosticoViewContent = document.getElementById('diagnosticoViewContent');
                elements.diagnosticoDisplay = document.getElementById('diagnosticoDisplay');
                
                // Elementos dentro de #longTermMemoryViewContent
                elements.longTermMemoryViewContent = document.getElementById('longTermMemoryViewContent');
                elements.longTermMemoryDisplay = document.getElementById('longTermMemoryDisplay');
                
                // Esta é uma NodeList de todos os view-content, também deve ser re-obtida após a injeção
                elements.viewContents = elements.mainContentArea.querySelectorAll('.view-content');

                console.log("DEBUG: initializeDynamicDOMElementsInMainContent finished.");
            }

            // FUNÇÃO PRINCIPAL DE INICIALIZAÇÃO DA UI (chamada após o login)
            function initializeAppUIAndDisplay() {
                console.log("DEBUG: initializeAppUIAndDisplay started.");
                
                // Sempre limpar o mainContentArea e reinserir o template para garantir um estado limpo
                elements.mainContentArea.innerHTML = '';
                const contentFragment = elements.viewsTemplate.content.cloneNode(true);
                elements.mainContentArea.appendChild(contentFragment);  
                console.log("DEBUG: Main content area populated from views-template.");

                // Agora que os elementos estão no DOM, podemos coletar suas referências
                initializeDynamicDOMElementsInMainContent();

                // Define textos e visibilidades iniciais para os elementos da UI principal
                if (elements.chatAiThinkingSrOnly) elements.chatAiThinkingSrOnly.textContent = i18nStrings.aiProcessing;
                if (elements.chatAiThinkingVisible) elements.chatAiThinkingVisible.textContent = i18nStrings.aiProcessing;
                
                if (elements.suggestedTasksTitleSpan) elements.suggestedTasksTitleSpan.textContent = i18nStrings.suggestedTasksTitle;
                if (elements.suggestedProjectsTitleSpan) elements.suggestedProjectsTitleSpan.textContent = i18nStrings.suggestedProjectsTitle;

                if (elements.userDisplayArea) elements.userDisplayArea.style.display = 'flex';
                if (elements.userName && currentUser) {
                    elements.userName.textContent = currentUser.displayName?.split(' ')[0] || 'Usuário';
                }
                if (elements.welcomeMessage) elements.welcomeMessage.textContent = getPersonalizedGreeting();
                
                // Aplica o tema aos elementos dinâmicos (como ícones de tema nos botões móveis)
                applyInitialTheme(); // Isso precisa ser chamado AQUI para atualizar ícones dos botões móveis (que são dinâmicos)
                
                // Ativa a primeira view (chat)
                switchView('chatViewContent'); 
                
                // Configura listeners para elementos dinâmicos (que não são capturados pelo handleGlobalClick no body)
                // Ex: listener para Enter no messageInput
                if (elements.messageInput) {
                    elements.messageInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            handleSendMessage();
                        }
                    });
                    console.log("DEBUG: Keydown listener added to messageInput.");
                } else {
                    console.warn("DEBUG: messageInput not found to attach keydown listener.");
                }
                
                // Adicionar listener para fileInput
                if (elements.fileInput) {
                    elements.fileInput.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        
                        if (file.size > config.MAX_FILE_SIZE) {
                            showToast(i18nStrings.fileTooLarge, 'error');
                            elements.fileInput.value = '';
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = async (readerEvent) => {
                            currentFileUpload = {
                                filename: file.name,
                                content_base64: readerEvent.target.result.split(',')[1],
                                mimetype: file.type || 'application/octet-stream'
                            };
                            
                            // Mostrar nome do arquivo na UI
                            if (elements.fileNameDisplay) {
                                elements.fileNameDisplay.textContent = file.name;
                            }
                            if (elements.attachmentInfoDiv) {
                                elements.attachmentInfoDiv.style.display = 'flex';
                            }
                            if (elements.fileUploadBtn) {
                                elements.fileUploadBtn.style.display = 'none';
                            }
                            console.log("DEBUG: File attached:", file.name, "Size:", file.size, "bytes");
                        };
                        reader.onerror = () => {
                            showToast('Erro ao ler arquivo. Tente novamente.', 'error');
                            elements.fileInput.value = '';
                        };
                        reader.readAsDataURL(file);
                    });
                    console.log("DEBUG: Change listener added to fileInput.");
                }                // Configura o relógio
                updateClockDisplay();
                if (!window.clockInterval) {
                    window.clockInterval = setInterval(updateClockDisplay, 1000);
                }

                // Removi a parte de anexar listeners para mobileThemeToggleBtn e mobileSignOutBtn aqui.
                // Eles serão anexados dentro de displayLongTermMemory() quando o template do perfil for renderizado.

                console.log("DEBUG: initializeAppUIAndDisplay finished.");
            }

            function setupEventListeners() {
                console.log("DEBUG: setupEventListeners started. (Global event delegation)");
                // Delega eventos para document.body para capturar cliques em elementos dinâmicos
                document.body.addEventListener('click', handleGlobalClick); 
                document.body.addEventListener('input', handleGlobalInput); 
                document.body.addEventListener('change', handleGlobalChange); 

                document.body.addEventListener('submit', (e) => e.preventDefault()); 

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && activeModalElement) {
                        closeModal(activeModalElement.id);
                    }
                });

                window.addEventListener('offline', () => { console.log("DEBUG: Offline event."); showToast(i18nStrings.offlineMessage, 'error', 0); }); 
                window.addEventListener('online', () => { console.log("DEBUG: Online event."); showToast(i18nStrings.onlineMessage, 'success'); });
                console.log("DEBUG: setupEventListeners finished.");
            }

            function handleGlobalClick(e) {
                const target = e.target; 
                console.log("DEBUG: handleGlobalClick - target:", target.id, target.className, target.tagName);

                // Authentication logic (elementos estáticos ou já presentes)
                if (target.closest('#emailLoginBtn')) handleEmailPasswordLogin();
                else if (target.closest('#emailSignupBtn')) handleEmailPasswordSignup();
                else if (target.closest('#googleLoginBtn')) handleGoogleLogin();
                // Google Calendar: Estes botões são dinâmicos dentro do perfil, mas handleGlobalClick
                // funciona por delegação. As referências `elements.connectGoogleCalendarBtn` etc.
                // não são usadas aqui, apenas `target.closest()`.
                else if (target.closest('#connectGoogleCalendarBtn')) handleConnectGoogleCalendar();
                else if (target.closest('#syncGoogleCalendarBtn') || target.closest('#syncGoogleCalendarBtnAgenda')) handleSyncGoogleCalendar();
                else if (target.closest('#disconnectGoogleCalendarBtn')) handleDisconnectGoogleCalendar();
                // Mobile Settings Buttons: Também são dinâmicos dentro do perfil, mas a delegação global funciona.
                else if (target.closest('#mobileThemeToggleBtn')) toggleTheme();
                else if (target.closest('#mobileSignOutBtn')) firebase.auth().signOut();


                // Sidebar and global controls logic (elementos estáticos ou re-referenciados)
                else if (target.closest('#sidebarToggleBtn')) elements.sidebarMenu.classList.toggle('collapsed');
                else if (target.closest('.tab-button')) {
                    const viewName = target.closest('.tab-button').dataset.targetView;
                    // Converte "agenda" para "agendaViewContent", "chat" para "chatViewContent", etc.
                    const fullViewId = viewName === 'chat' ? 'chatViewContent' : viewName + 'ViewContent';
                    switchView(fullViewId);
                }
                else if (target.closest('#signOutBtn')) firebase.auth().signOut();
                else if (target.closest('#themeToggleBtn')) toggleTheme();
                else if (target.closest('.modal .close-button')) closeModal(target.closest('.modal').id);

                // Chat area and attachments logic (elementos dinâmicos)
                else if (target.closest('#sendMessageBtn')) handleSendMessage();
                else if (target.closest('#fileUploadBtn')) elements.fileInput?.click();
                else if (target.closest('.attachment-clear-icon')) clearAttachment();
                else if (target.closest('.ai-message .copy-button')) copyAiMessageContent(target);

                // FAB EIXA (estático)
                else if (target.closest('.eixa-icon-fab')) {
                    e.preventDefault(); 
                    switchView('chatViewContent'); // Alterado para o nome da div diretamente
                }
                
                // Confirmation buttons in chat (dinâmicos)
                else if (target.closest('#confirmYesBtnChat')) handleConfirmationResponse('yes');
                else if (target.closest('#confirmNoBtnChat')) handleConfirmationResponse('no');

                // CRUD Modals logic (botões dentro de views dinâmicas)
                else if (target.closest('#openAddTaskModalBtn')) {
                    e.stopPropagation(); 
                    openAddTaskModal();
                }
                else if (target.closest('#openAddProjectModalBtn')) {
                    e.stopPropagation(); 
                    openEditProjectModal(); 
                }
                else if (target.closest('#openAddRoutineModalBtn') || target.closest('#openAddRoutineModalBtnSecondary')) { 
                    e.stopPropagation();
                    openEditRoutineModal();
                }
                else if (target.closest('#viewRoutineTemplatesBtn')) { 
                    e.stopPropagation();
                    switchView('rotinasTemplatesViewContent'); 
                    showToast("Exibindo templates de rotina.", 'info');
                }
                else if (target.closest('#saveNewTaskBtn')) saveNewTask();
                else if (target.closest('#addMicrotaskModalBtn')) addMicrotaskToModal();
                else if (target.closest('#addRoutineItemModalBtn')) addRoutineItemToModal();
                else if (target.closest('#saveProjectChangesBtn')) saveProjectChanges();
                else if (target.closest('#saveRoutineBtn')) saveRoutine();
                // Confirmation Modal buttons (general modals, estáticos, mas seu conteúdo é populado)
                else if (target.closest('#confirmYesBtn')) {  
                    const confirmYesBtn = elements.confirmationModal.querySelector('#confirmYesBtn');
                    if (confirmYesBtn && confirmYesBtn._callback) {
                        confirmYesBtn._callback();  
                    }
                    closeModal('confirmationModal');    
                }
                else if (target.closest('#confirmNoBtn')) { 
                    const confirmNoBtn = elements.confirmationModal.querySelector('#confirmNoBtn');
                    if (confirmNoBtn && confirmNoBtn._callback) {
                         confirmNoBtn._callback(); 
                    }
                    closeModal('confirmationModal');
                }
                else if (target.closest('.confirm-secondary')) { 
                    const secondaryBtn = target.closest('.confirm-secondary');
                    if (secondaryBtn && secondaryBtn._callback) {
                        secondaryBtn._callback();
                    }
                    closeModal('confirmationModal');
                }

                // Agenda Task Actions logic (blocos de evento dinâmicos)
                else if (target.closest('.agenda-event-block')) {
                    const taskBlock = target.closest('.agenda-event-block');
                    const taskId = taskBlock.dataset.id;
                    const taskDate = taskBlock.dataset.date;
                    const taskDescription = taskBlock.dataset.description;
                    const taskTime = taskBlock.dataset.time;
                    const taskDuration = taskBlock.dataset.durationMinutes;
                    const taskCompleted = taskBlock.dataset.completed === 'true';
                    const taskOrigin = taskBlock.dataset.origin;
                    const googleCalendarId = taskBlock.dataset.googleCalendarEventId;

                    // Diferencia a ação com base na origem
                    if (taskOrigin === 'google_calendar') {
                        showToast(`Evento do Google Calendar: "${taskDescription}" de ${taskTime}. Edite-o diretamente no seu Google Calendar.`, 'info', 5000);
                    } else if (taskOrigin === 'routine') {
                        showConfirmationModal(`Esta é uma tarefa da rotina "${escapeHTML(taskDescription)}". O que deseja fazer?`, 
                            () => { 
                                sendCrudRequest('task', 'update', taskId, { date: taskDate, completed: !taskCompleted, time: taskTime, duration_minutes: parseInt(taskDuration) });
                            }, 
                            () => { 
                                showConfirmationModal(`Tem certeza que deseja EXCLUIR APENAS ESTA INSTÂNCIA de "${escapeHTML(taskDescription)}"?`, () => {
                                    sendCrudRequest('task', 'delete', taskId, { date: taskDate });
                                });
                            },
                            () => { 
                                switchView('rotinasTemplatesViewContent'); 
                                showToast(`Vá para a rotina "${escapeHTML(taskDescription)}" na aba "Templates de Rotina" para editá-la.`, 'info', 7000);
                            },
                            false, 
                            taskCompleted ? i18nStrings.confirmTaskMarkPending : i18nStrings.confirmTaskMarkComplete, 
                            i18nStrings.confirmTaskDeleteInstance, 
                            i18nStrings.viewRoutineTemplate 
                        );

                    } else { // 'user_added' (tarefa normal da EIXA)
                        showConfirmationModal(`O que deseja fazer com "${escapeHTML(taskDescription)}" às ${taskTime} em ${formatDate(taskDate)}?`, 
                            () => { 
                                sendCrudRequest('task', 'update', taskId, { date: taskDate, completed: !taskCompleted, time: taskTime, duration_minutes: parseInt(taskDuration) });
                            }, 
                            () => { 
                                showConfirmationMod